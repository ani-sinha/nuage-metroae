---
- name: Wait for VNS Utility VM ssh to be ready
  include_role:
    name: common
    tasks_from: wait-for-ssh
  vars:
    ssh_host: "{{ mgmt_ip }}"

- block:
  - name: Update /etc/hosts file on {{ target_server }}
    lineinfile:
      dest: /etc/hosts
      line: "{{ mgmt_ip }} {{ inventory_hostname }}"
    delegate_to: "{{ target_server }}"
    remote_user: "{{ target_server_username }}"
  when: not target_server_type | match("vcenter")

- block:

  - name: Update /etc/hosts file
    blockinfile:
      dest: /etc/hosts
      block: |
        {% for host in groups['vnsutils']  %}
        {{ hostvars[host]['mgmt_ip'] }}    {{ host }}
        {% endfor %}

  - name: Configure yum proxy
    lineinfile:
      dest: /etc/yum.conf
      regexp: "^proxy="
      line: "proxy={{ yum_proxy }}"
    when: not yum_proxy | match('NONE')

  - name: Install NTP package on the vnsutil vm
    yum: name=ntp state=present

  remote_user: "{{ vcin_username }}"

- name: Configure ntpd and ntpdate and local time zone
  include_role:
    name: common
    tasks_from: linux-ntp-sync

- block:

  - name: Install dhcp package
    yum: name=dhcp state=present

  - name: Copy dhcp config
    template: src=dhcpd.conf.j2 backup=no dest=/etc/dhcp/dhcpd.conf

  - name: Restart dhcp service
    service:
      name: dhcpd
      state: restarted

  - name: Chkconfig of dhcpd
    command: chkconfig dhcpd on

  - name: Install dnsmasq package
    yum: name=dnsmasq state=present

  - name: Copy dnsmasq config
    template: src=dnsmasq.conf.j2 backup=no dest=/etc/dnsmasq.conf

  - name: Start dnsmasq
    service:
      name: dnsmasq
      state: started

  - name: Chkconfig of dnsmasq
    command: chkconfig dnsmasq on

  remote_user: "{{ vcin_username }}"
  when: nsgv_ip is defined or nsgv_mac is defined or nsgv_host_name is defined
