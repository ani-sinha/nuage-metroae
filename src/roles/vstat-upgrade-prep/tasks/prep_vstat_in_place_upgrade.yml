- name: Get elasticsearch version
  command: "curl localhost:9200"
  register: es_version

- name: Convert es_version output to json
  set_fact:
    es_version_json: "{{ es_version.stdout | from_json }}"

- name: Stat the current es version log file
  stat: path=/root/current_es_version.log
  register: es_version

- name: Write current es version to file on vstat node(s)
  shell: echo "{{ es_version_json.version.number }}" >> /root/current_es_version.log
  when: not es_version.stat.exists

- name: Get vsd node(s) information
  import_role:
    name: common
    tasks_from: vsd-node-info.yml
  vars:
    vsd_hostname: "{{ vsd_fqdn }}"
  run_once: true

- block:

  - name: Disable stats collection on all VSD nodes
    command: /opt/vsd/vsd-stats.sh -d
    delegate_to: "{{ item }}"
    with_items: "{{ vsd_hostname_list }}"

  remote_user: "{{ vsd_custom_username | default(vsd_default_username) }}"
  become: "{{ 'no' if vsd_custom_username | default(vsd_default_username) == 'root' else 'yes' }}"
  vars:
    ansible_become_pass: "{{ vsd_custom_password | default(vsd_default_password) }}"
  run_once: true
