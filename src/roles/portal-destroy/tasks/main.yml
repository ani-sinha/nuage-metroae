---
- name: List the Virtual Machines on {{ target_server }}
  virt: command=list_vms
  register: virt_vms
  delegate_to: "{{ target_server }}"
  remote_user: "{{ target_server_username }}"

- block:
  - name: Destroy Portal VM
    virt:
      name: "{{ vm_name }}"
      state: destroyed
      uri: qemu:///system

  - name: Undefine Portal VM
    virt:
      name: "{{ vm_name }}"
      command: undefine
      uri: qemu:///system

  - name: Destroy the images directory
    file:
      path: "{{ images_path }}/{{ vm_name }}"
      state: absent
  delegate_to: "{{ target_server }}"
  remote_user: "{{ target_server_username }}"
  when: vm_name in virt_vms.list_vms
