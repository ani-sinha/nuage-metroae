---
- name: Wait for VSTAT ssh to be ready
  local_action:
    module: wait_for
    port: "22"
    host: "{{ interfaces.mgmt.ip }}"
    search_regex: OpenSSH
    delay: 1
  delegate_to: "{{ target_server }}"
  remote_user: root

- name: Update /etc/hosts file on {{ inventory_hostname }}
  lineinfile:
    dest: /etc/hosts
    line: "{{ interfaces.mgmt.ip }} {{ inventory_hostname }}"
  remote_user: root

- name: Delete the localtime file on {{ inventory_hostname }}
  file:
    path: /etc/localtime
    state: absent
  remote_user: root

- name: Create the localtime symlink on {{ inventory_hostname }}
  file:
    src: /usr/share/zoneinfo/US/Pacific
    dest: /etc/localtime
    state: link
  remote_user: root

- name: Remove old NTP servers on {{ inventory_hostname }}
  lineinfile:
    dest: /etc/ntp.conf
    regexp: "^server"
    state: absent
  remote_user: root

- name: Configure NTP servers on {{ inventory_hostname }}
  lineinfile:
    dest: /etc/ntp.conf
    line: "server {{ item }} iburst"
  with_items: "{{ ntp_server_list }}"
  remote_user: root

- name: Stop the ntpd service if running
  command: service ntpd stop
  remote_user: root

- pause: seconds=20

- name: Manually sync time with ntp server
  command: ntpdate -u "{{ntp_server_list[0]}}"
  remote_user: root

- pause: seconds=20

- name: Start ntpd on {{ inventory_hostname }}
  command: service ntpd start
  remote_user: root

- pause: seconds=20

- name: check ntp sync state
  shell: ntpstat | awk 'NR==1{print $1}'
  register: sync_status
  until: sync_status.stdout == "synchronised"
  retries: 29
  delay: 10
  remote_user: root

- debug: var=sync_status

- name: Resolve "{{vsd_fqdn}}"  to ip addr
  shell: host "{{vsd_fqdn}}" | awk '{print $3,$4}'
  register: ip_addr
  remote_user: root

- name: Check for ip addr in the registered var
  fail: msg="Could not resolve ip addr of "{{vsd_fqdn}}" "
  when: ip_addr.stdout == "not found:"
  remote_user: root

- name: Config firewall on VSTAT vm to accept conn on ports 9200,9300 from vsd(s)
  script: firewall.sh "{{ ip_addr.stdout.split()[1] }}"
  remote_user: root

- name: Restart elastic search {{ inventory_hostname }}
  command: systemctl restart elasticsearch
  remote_user: root

- name: Enable stats collection on the VSD VM
  command: /opt/vsd/vsd-stats.sh -e {{inventory_hostname}}
  delegate_to: "{{vsd_fqdn}}"
  remote_user: root
