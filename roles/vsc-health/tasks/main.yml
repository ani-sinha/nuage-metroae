---
# tasks file for vsc

- name: Wait for VSC ssh to be ready
  local_action:
    module: wait_for
    port: "22"
    host: "{{ interfaces.mgmt.ip }}"
    search_regex: OpenSSH
    delay: 1
  tags:
    - vsc
    - vsc-deploy
    - vsc-health

- name: Get output of 'show router bgp summary'
  sros_command:
    commands:
      - show router bgp summary
    provider: "{{ vsc_creds }}"
  register: bgp_summary
  delegate_to: localhost

- name: Print 'show router bgp summary' when verbosity >= 1
  debug: var=bgp_summary verbosity=1

- name: Create local variable with BGP Summary in json
  set_fact: bgp_summary_json="{{ bgp_summary.stdout[0]|bgp_summary_to_json }}"

- name: Print BGP Summary in json when verbosity >= 1
  debug: var=bgp_summary_json verbosity=1

- name: Create local variable with BGP Admin State
  set_fact: bgp_admin_state="{{ bgp_summary_json['BGP Admin State'] }}"

- name: Print BGP Admin State when verbosity >= 1
  debug: var=bgp_admin_state verbosity=1

- name: Check for expected BGP Admin State, skip if okay
  fail: msg="Unexpected BGP Admin State - {{ bgp_admin_state }}. Expected '{{ expected_bgp_admin_state }}'. Check output of 'show router bgp summary' on {{ inventory_hostname }}."
  when: "'{{ expected_bgp_admin_state }}' not in bgp_admin_state"
  ignore_errors: yes

- name: Create local variable for BGP Oper State
  set_fact: bgp_oper_state="{{ bgp_summary_json['BGP Oper State'] }}"

- name: Print BGP Oper State when verbosity >= 1
  debug: var=bgp_oper_state verbosity=1

- name: Check for expected BGP Oper State, skip if okay
  fail: msg="Unexpected BGP Oper State - {{ bgp_oper_state }}. Expected '{{ expected_bgp_oper_state }}'. Check output of 'show router bgp summary' on {{ inventory_hostname }}."
  when: "'{{ expected_bgp_oper_state }}' not in bgp_oper_state"
  ignore_errors: yes

- name: Create local variable for BGP Peer Count
  set_fact: bgp_peer_count="{{ bgp_summary_json['Total Peers'] }}"

- name: Print BGP Peer Count when verbosity >= 1
  debug: var=bgp_peer_count verbosity=1

- name: Check for expected BGP Peer Count, skip if okay
  fail: msg="Invalid BGP Peer count ({{ bgp_peer_count }}) detected. Expected '{{ expected_num_bgp_peers }}'. Check 'show router bgp summary' on {{ inventory_hostname }}."
  when: "{{ expected_num_bgp_peers }} != {{ bgp_peer_count }}"
  ignore_errors: yes

- name: Print number of BGP Peer details when verbosity >= 1
  debug: var=bgp_summary_json['Peers']|length verbosity=1

- name: Make sure we have details for the correct number of peers, skip if okay
  fail: msg="Didn't find enough sets of details for BGP peers. Found {{ bgp_summary_json['Peers']|length }}. Expected '{{ expected_num_bgp_peers }}'. Check 'show router bgp summary' on {{ inventory_hostname }}."
  when: "{{ expected_num_bgp_peers }} != {{ bgp_summary_json['Peers']|length }}"
  ignore_errors: yes

- name: Get output of 'show vswitch-controller xmpp-server detail'
  sros_command:
    commands:
      - show vswitch-controller xmpp-server detail
    provider: "{{ vsc_creds }}"
  register: xmpp_detail
  delegate_to: localhost

- name: Print 'show vswitch-controller xmpp-server detail' when verbosity >= 1
  debug: var=xmpp_detail verbosity=1

- name: Create local variable with xmpp-server detail in json
  set_fact: xmpp_detail_json="{{ xmpp_detail.stdout[0]|xmpp_server_detail_to_json }}"

- name: Print xmpp-server detail in json when verbosity >= 1
  debug: var=xmpp_detail_json verbosity=1

- name: Create local variable for xmpp-server state
  set_fact: xmpp_server_state="{{ xmpp_detail_json['State'] }}"

- name: Print xmpp-server state when verbosity >= 1
  debug: var=xmpp_server_state verbosity=1

- name: Check for the expected xmpp-server state, skip if okay
  fail: msg="Invalid xmpp-server state ({{ xmpp_server_state }}) detected. Expected {{ expected_xmpp_server_state }}. Check 'show vswitch-controller xmpp-server details' on {{ inventory_hostname }}."
  when: expected_xmpp_server_state != xmpp_server_state
  ignore_errors: yes

- name: Get output of 'show vswitch-controller vswitches'
  sros_command:
    commands:
      - show vswitch-controller vswitches
    provider: "{{ vsc_creds }}"
  register: show_vswitches
  delegate_to: localhost

- name: Print output of 'show vswitch-controller vswitches' when verbosity >= 1
  debug: var=show_vswitches verbosity=1

- name: Create local variable with show vswitches output in json
  set_fact: show_vswitches_json="{{ show_vswitches.stdout[0]|show_vswitches_to_json }}"

- name: Print show vswitches in json when verbosity >= 1
  debug: var=show_vswitches_json verbosity=1

- name: Check for the expected number of vswitches, skip if okay
  fail: msg="Invalid vswitch count ({{ show_vswitches_json['No. of virtual switches'] }}) detected. Expected {{ expected_num_vswitches }}. Check 'show vswitch-controller vswitches' on {{ inventory_hostname }}."
  when: "{{ expected_num_vswitches }} != {{ show_vswitches_json['No. of virtual switches'] }}"
  ignore_errors: yes

- name: Get output of 'show vswitch-controller vports type host detail'
  sros_command:
    commands:
      - show vswitch-controller vports type host detail
    provider: "{{ vsc_creds }}"
  register: show_vports
  delegate_to: localhost

- name: Print output of 'show vswitch-controller vports type host detail' when verbosity >= 1
  debug: var=show_vports verbosity=1

- name: Create local variable with show vports output in json
  set_fact: show_vports_json="{{ show_vports.stdout[0]|show_vports_to_json }}"

- name: Print show vports in json when verbosity >= 1
  debug: var=show_vports_json verbosity=1

- name: Check for the expected number of vports, skip if okay
  fail: msg="Invalid vport count ({{ show_vports_json['No. of virtual ports'] }}) detected. Expected {{ expected_num_vports }}. Check 'show vswitch-controller vports type host detail' on {{ inventory_hostname }}."
  when: "{{ expected_num_vports }} != {{ show_vports_json['No. of virtual ports'] }}"
  ignore_errors: yes

- name: Check for existence of error report
  stat:
    path: "{{ failure_report_file_name }}"
  register: report
  delegate_to: localhost

- name: If the error report exists declare failure, otherwise skip (Success!)
  fail: msg="One or more failures detected. Check {{ failure_report_file_name }} for details."
  when: report.stat.exists
