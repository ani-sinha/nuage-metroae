---
- name: Create dir to hold the keys 
  file: 
    path: "/opt/proxy/config/keys"
    state: directory
  remote_user: root

- name: Get VSD version
  shell: echo $VSD_VERSION
  register: vsd_version
  delegate_to: "{{ vsd_fqdn }}"
  remote_user: root
  
- name: Create and transfer certs for VSD 4.0.4 to {{ inventory_hostname }}
  expect:
    command: "{{ create_certs_404 }}"
    responses:
      (?i)password: "Alcateldc"
  delegate_to: "{{ vsd_fqdn }}"
  remote_user: root
  when: vsd_version.stdout == "4.0.4"

- name: Create and transfer certs to {{ inventory_hostname }}
  expect:
    command: "{{ create_certs }}"
    responses:
      (?i)password: "Alcateldc"
  delegate_to: "{{ vsd_fqdn }}"
  remote_user: root
  when: vsd_version.stdout != "4.0.4"

- name: Install supervisord and haproxy
  command: "{{ install_cmd }}"
  remote_user: root

- name: Start supervisord
  service: 
    name: supervisord
    state: restarted
  remote_user: root

- name: Chkconfig supervisord
  command: chkconfig supervisord on
  remote_user: root

- name: Start haproxy
  service:
    name: haproxy
    state: started
  remote_user: root

- name: Chkconfig haproxy
  command: chkconfig haproxy on
  remote_user: root

- name: Add firewall rules to accept dhcp and dns requests
  lineinfile: 
    insertafter: '<service name="ssh"/>'
    dest: /etc/firewalld/zones/public.xml
    line: "{{ item }}"
  with_items: "{{ firewall_rules }}"
  remote_user: root

- name: Restart firewalld on {{ inventory_hostname }}
  service:
    name: firewalld
    state: restarted
  remote_user: root
