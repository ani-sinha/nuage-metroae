---
- block:

  - name: Create SSL directory on the Stats node
    file: path=/etc/nginx/ssl state=directory owner=root group=root mode=600

  - name: Revoke old stats cert, if any
    command: "/opt/vsd/ejbca/deploy/certMgmt.sh -a revoke -u elastic"
    remote_user: "{{ vsd_username }}"
    become: "{{ 'no' if vsd_username == 'root' else 'yes' }}"
    vars:
      ansible_become_pass: "{{ vsd_password }}"
    vars_files:
      - "{{ user_creds_file | default (inventory_dir+'/user_creds.yml') }}"
    delegate_to: "{{ vsd_fqdn }}"
    ignore_errors: yes
  
  remote_user: "{{ vstat_username }}"

- block:

  - name: Generate SSL certificates on VSD for the Stats node
    command: "/bin/sshpass -p{{ vstat_password }} /opt/vsd/ejbca/deploy/certMgmt.sh -a generate -u elastic -c elastic -o csp -f pem -t server -d {{ mgmt_ip }}"
    register: sslresult
    remote_user: "{{ vsd_username }}"
    become: "{{ 'no' if vsd_username == 'root' else 'yes' }}"
    vars:
      ansible_become_pass: "{{ vsd_password }}"
    vars_files:
      - "{{ user_creds_file | default (inventory_dir+'/user_creds.yml') }}"
    delegate_to: "{{ groups['vsds'][0] }}"

  - name: Create temp folder to host the ssl certificates
    local_action: file path={{ dest }} state=directory mode=755

  - name: Transfer SSL certificates from VSD to localhost
    fetch: src=/opt/vsd/ejbca/p12/pem/{{ item }} dest={{ dest }} flat=yes
    with_items: "{{ pem_list }}"
    remote_user: "{{ vsd_username }}"
    become: "{{ 'no' if vsd_username == 'root' else 'yes' }}"
    vars:
      ansible_become_pass: "{{ vsd_password }}"
    vars_files:
      - "{{ user_creds_file | default (inventory_dir+'/user_creds.yml') }}"
    delegate_to: "{{ groups['vsds'][0] }}"
    include_role:
      name: common
      tasks_from: vsd-generate-transfer-certificates
    vars:
      certificate_password: "{{ vstat_password }}"
      certificate_username: elastic
      commonName: elastic
      certificate_type: server
      scp_user: "{{ vstat_username }}"
      scp_location: ~
      additional_parameters:  -d {{ inventory_hostname }}

