---
- block:

  - block: # QCOW2

    - name: Find name of VSD QCOW2 File
      find: path="{{ nuage_unzipped_files_dir }}/vsd/qcow2" pattern="*.qcow2" recurse=yes
      register: rc_vsd_file

    - debug: var=rc_vsd_file verbosity=1

    - name: Verify that a VSD QCOW2 file was found
      assert: {
        that: "{{ rc_vsd_file.matched }} > 0",
        msg: "Unable to find VSD VM image file"
        }

    - name: Register VSD QCOW2 variables with proper path and image locations for use in other playbooks
      set_fact:
        qcow2_path: "{{ rc_vsd_file.files[0].path | dirname }}"
        qcow2_file_name: "{{ rc_vsd_file.files[0].path | basename }}"

    when: ( myvsds is defined and
          ( myvsds | map(attribute='target_server_type') | list | issuperset(["kvm"]) ) ) or
          ( myvcins is defined and
          ( myvcins | map(attribute='target_server_type') | list | issuperset(["kvm"]) ) )

  - block: # OVA

    - name: Find name of VSD OVA File
      find: path="{{ nuage_unzipped_files_dir }}/vsd/ova"  pattern="*.ova" recurse=yes
      register: rc_vsd_file

    - debug: var=rc_vsd_file verbosity=1

    - name: Verify that a VSD OVA file was found
      assert: {
        that: "{{ rc_vsd_file.matched }} > 0",
        msg: "Unable to find VSD VM image file"
        }

    - name: Register VSD OVA variables with proper path and image locations for use in other playbooks
      set_fact:
        ova_path: "{{ rc_vsd_file.files[0].path | dirname }}"
        ova_file_name: "{{ rc_vsd_file.files[0].path | basename }}"

    when: ( myvsds is defined and
          myvsds | map(attribute='target_server_type') | list | issuperset(["vcenter"]) ) or
          ( myvcins is defined and
          myvcins | map(attribute='target_server_type') | list | issuperset(["vcenter"]) )

  - name: Set myvsds_check
    set_fact: myvsds_check={{myvsds is defined}}

  - name: Assign empty list to myvsds if it is undefined
    set_fact: myvsds= default([])
    when: not myvsds_check

  - block:
    - name: Verify that vsd_fqdn_globl is defined
      assert:
        that:
          - "vsd_fqdn_global is defined"
        msg: "vsd_fqdn_global must be defined. See build_vars.yml."
 
    - name: Create host_vars files for vsd
      template: src=vsd.j2 backup=no dest={{ playbook_dir }}/host_vars/{{ item.hostname }}
      with_items: "{{ myvsds }}"
    when: myvsds_check

  when: "'upgrade' in vsd_operations_list|default(['None']) or
        'install' in vsd_operations_list|default(['None']) or
        'upgrade' in vcin_operations_list|default(['None']) or
        'install' in vcin_operations_list|default(['None'])"

- block: # ISO

  - name: Find name of VSD Migration ISO File
    find: path="{{ nuage_upgrade_unzipped_files_dir }}/vsd/migration"  pattern="*.iso" recurse=yes
    register: rc_vsd_migration_file

  - debug: var=rc_vsd_migration_file verbosity=1

  - name: Verify that a VSD migration ISO file was found
    assert: {
      that: "{{ rc_vsd_migration_file.matched }} > 0",
      msg: "Unable to find VSD Migration ISO image file"
      }

  - name: Register VSD Migration ISO variables with proper path and image locations for use in other playbooks
    set_fact:
      vsd_migration_iso_path: "{{ rc_vsd_migration_file.files[0].path | dirname }}"
      vsd_migration_iso_file_name: "{{ rc_vsd_migration_file.files[0].path | basename }}"

  when: 
    - myvsds is defined or myvcins is defined
    - "'upgrade' in vsd_operations_list|default(['None']) or
       'upgrade' in vcin_operations_list|default(['None'])"
  tags:
    - vsd
