- name: Get current VSD version
  command: echo $VSD_VERSION
  register: vsd_version

- name: Print update time output when verbosity >= 1
  debug: var=vsd_version verbosity=1

- block:      
  - name: Stop vsd-stats group on VSD(s)
    command: monit stop -g vsd-stats
    remote_user: "{{ ansible_sudo_username }}"

  - name: Get monit state for stat processes
    vsd_monit:
      state: group_summary
      group: vsd-stats
    register: stats_state
    remote_user: "{{ ansible_sudo_username }}"

  - name: Verify stats processes are stopped
    assert: 
      that: stats_state['state']['{{ item }}'] == 'not monitored'
      msg: item  is still running 
    with_items: "{{ stats_state.state.keys() }}" 

  - name: Migrate current date data to new schema version
    command: "{{ migrate_current_data }}"
    remote_user: "{{ ansible_sudo_username }}"
    when: current_day_data

  - name: Migrate previous day data to new schema version
    command: "{{ migrate_previous_data }}"
    remote_user: "{{ ansible_sudo_username }}"
    when: not current_day_data

  - name: Start vsd-stats processess
    command: "monit start -g vsd-stats"
    remote_user: "{{ ansible_sudo_username }}"

  - name: Get monit state for stat processes
    vsd_monit:
      state: group_summary
      group: vsd-core
    register: stats_current_state
 
  - name: Fetch stats processess current state
    vsd_monit:
      state: group_summary
      group: vsd-stats
    until: stats_current_state['state']['{{ item }}'] == 'running' or stats_current_state['state']['{{ item }}'] == 'status ok'
    retries: 5
    delay: 30
    remote_user: "{{ ansible_sudo_username }}"
    with_items: "{{ stats_current_state.state.keys() }}"

  - name: Verify stats processes are started/running
    assert:
      that: stats_current_state['state']['{{ item }}'] == 'running' or stats_current_state['state']['{{ item }}'] == 'status ok'
      msg: item  is still running
    with_items: "{{ stats_current_state.state.keys() }}"
  when: vsd_version.stdout in supported_vsd_versions
