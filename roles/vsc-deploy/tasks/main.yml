---
- include: heat.yml
  when: target_server_type | match("heat")
  tags:
    - vsc
    - heat
    - vsc-deploy
    
- block:
  - name: set secure communication flag 
    set_fact: 
      secure_communication: "{{ secure_communication }}"
  
  - name: Change XMPP connection to TLS on VSD
    command: /opt/vsd/bin/ejmode allow -y
    delegate_to: "{{ item }}"
    with_items: "{{ groups['vsds'] }}"

  - name: wait for ejabberd-status to become running
    monit_waitfor_service:
      name: "ejabberd-status"
      timeout_seconds: 600
      test_interval_seconds: 30
    delegate_to: "{{ item }}"
    with_items: "{{ groups['vsds'] }}"

  - name: wait for ejbca-status to become running
    monit_waitfor_service:
      name: "ejbca-status"
      timeout_seconds: 600
      test_interval_seconds: 30
    delegate_to: "{{ item }}"
    with_items: "{{ groups['vsds'] }}"
    remote_user: "{{ vsd_username }}"
    
  - name: check for TLS during upgrade
    include_role:
      name: common
      tasks_from: vsc-tls-uprgade-check

  - name: setup TLS
    include_role: 
      name: common
      tasks_from: vsc-tls-setup
  