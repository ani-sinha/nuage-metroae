- name: Run when ejabberd license file is defined
  block:

  - name: Check that the ejabberdctl file exists
    stat:
      path: /opt/ejabberd/bin/ejabberdctl
    register: ejabberdctl_result

  - name: Install ejabberdctl if not present
    command: >
      "/opt/vsd/install/install_ejabberd.sh -9 /opt/vsd/Packages -x {{ vsd_fqdn }}"
    when: not ejabberdctl_result.stat.exists

  - name: Find the ejabberd base directory
    command: find /opt/ejabberd/lib/ -type d -name "ejabberd_nuage*"
    register: ejabberd_base_dir

  - name: Set fact for license file backup location
    set_fact:
      backup_location: "{{ ejabberd_base_dir }}/ebin"

  - name: Backup the current license files for ejabberd
    archive:
      path:
        - "{{ backup_location }}/ejabberd.beam"
        - "{{ backup_location }}/ejabberd_admin.beam"
        - "{{ backup_location }}/ejabberd_c2s.beam"
        - "{{ backup_location }}/ejabberd_cluster.beam"
        - "{{ backup_location }}/ejabberd_config.beam"
        - "{{ backup_location }}/ejabberd_listener.beam"
        - "{{ backup_location }}/ejabberd_sm.beam"
      dest: "{{ backup_location }}/orig_backup.tgz"

  - name: Copy new ejabberd license file to root folder on VSD
    copy:
      dest: "/root/"
      src: "{{ vsd_ejabberd_license_file }}"

  - name: Untar the new ejabberd license file
    unarchive:
      src: "/root/{{ vsd_ejabberd_license_file | basename }}"
      dest: "{{ backup_location }}"

  - name: Change ownership of licenses
    file:
      path: "{{ item }}"
      owner: ejabberd
      group: hadoopusers
    with_items:
      - "{{ backup_location }}/ejabberd_license.beam"
      - "{{ backup_location }}/ejabberd_cluster.beam"
      - "{{ backup_location }}/ejabberd_c2s.beam"
      - "{{ backup_location }}/ejabberd.beam"
      - "{{ backup_location }}/ejabberd_sm.beam"
      - "{{ backup_location }}/ejabberd_router.beam"
      - "{{ backup_location }}/ejabberd_listener.beam"
    when: not(ejabberd_base_dir.stdout is search("3.2.13_5"))

  - name: Change ownership of licenses for version 3.2.13_5
    file:
      path: "{{ item }}"
      owner: ejabberd
      group: hadoopusers
    with_items:
      - "{{ backup_location }}/ejabberd_cluster.beam"
      - "{{ backup_location }}/ejabberd_c2s.beam"
      - "{{ backup_location }}/ejabberd.beam"
      - "{{ backup_location }}/ejabberd_sm.beam"
      - "{{ backup_location }}/ejabberd_router.beam"
      - "{{ backup_location }}/ejabberd_listener.beam"
    when: ejabberd_base_dir.stdout is search("3.2.13_5")

  - name: Start ejabberd
    command: /opt/ejabberd/bin/ejabberdctl start
    register: license_check_after_renew

  - name: Check that new ejabberd license is valid
    command: /opt/ejabberd/bin/ejabberdctl license_info
    register: license_check_after_renew
    retries: 5
    until: "license_check_after_renew.rc == 0"
    delay: 20

  - name: Stop ejabberd service
    command: /opt/ejabberd/bin/ejabberdctl stop

  when: vsd_ejabberd_license_file is defined
  remote_user: "{{ vsd_default_username }}"
