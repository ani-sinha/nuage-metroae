- block:
  - debug: msg='{{ lookup("template", "vsr_xml.j2") }}'

  - name: Define VSR guest VM
    virt:
      name: '{{ vmname }}'
      command: define
      xml: '{{ lookup("template", "vsr_xml.j2") }}'
      uri: qemu:///system

  - name: Mark VSR as autostart
    virt:
      name: '{{ vmname }}'
      state: running
      autostart: True
      uri: qemu:///system
  when: ansible_version.full | version_compare('2.3', '>=')
  delegate_to: "{{ target_server }}"
  remote_user: "{{ target_server_username }}"


- block:
  - name: "Configure VM to autostart"
    command: virsh autostart {{ vmname }}

  - name: "Run VSR VM"
    virt:
      name: '{{ vmname }}'
      state: running
      uri: qemu:///system
  when: ansible_version.full | version_compare('2.3', '<')
  delegate_to: "{{ target_server }}"
  remote_user: "{{ target_server_username }}"

- block:

  - name: Get updated VM information from {{ target_server }}
    virt: command=info
    register: virt_info

  - name: Verify that VSR VM is running
    assert: { that: "virt_info['{{ vmname }}']['state'] == 'running'" }

  delegate_to: "{{ target_server }}"
  remote_user: "{{ target_server_username }}"
