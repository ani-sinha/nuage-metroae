---
- hosts: primary_cluster
  become: yes
  remote_user: "{{ vsd_default_username }}"
  tasks:
    - name: Run vsd-prepare-replication-master-cluster
      command: "/opt/vsd/bin/vsd-prepare-replication-master-cluster.sh"
      when: vsd_cluster | default(false)

- hosts: vsd_ha_node1
  become: yes
  remote_user: "{{ vsd_default_username }}"
  tasks:
    - name: Run vsd-prepare-replication-master on first cluster
      command: "/opt/vsd/bin/vsd-prepare-replication-master.sh -a {{ groups['vsd_ha_standby1'][0] }} -b {{ groups['vsd_ha_standby2'][0] }} -c {{ groups['vsd_ha_standby3'][0] }}"
      when:
        - vsd_cluster | default(false)

- hosts: vsd_ha_standby1
  become: yes
  remote_user: "{{ vsd_default_username }}"
  tasks:
    - name: Create data directory on first vm of standby
      command: "mkdir /opt/vsd/data"
      when:
        - vsd_cluster | default(false)

- hosts: vsd_ha_node1
  become: yes
  remote_user: "{{ vsd_default_username }}"
  tasks:
    - name: Generate SSH keys
      shell: ssh-keygen -b 2048 -t rsa -f /root/.ssh/id_rsa -q -N ""
      args:
        creates: /root/.ssh/id_rsa

    - name: Inject ssh key to backup vsd
      expect:
        command: "ssh-copy-id -i {{ vsd_default_username }}@{{ groups['vsd_ha_standby1'][0] }}"
        responses:
          (?i)yes: "yes"
          (?i)password: "{{ vsd_default_password }}"
      no_log: True

    - name: Transfer data from /tmp/backup/ to data folder
      command: "scp /tmp/backup/* root@{{ groups['vsd_ha_standby1'][0] }}:/opt/vsd/data/"
      when:
        - vsd_cluster | default(false)

- hosts: standby_cluster
  gather_facts: no
  pre_tasks:
    - name: Set cluster flag
      set_fact:
        install_cluster: true
  roles:
    - vsd-deploy

- hosts: vsd_ha_standby1
  become: yes
  remote_user: "{{ vsd_default_username }}"
  tasks:
    - name: Run the replication script
      command: "/opt/vsd/bin/vsd-start-replication-slave -m {{ groups['vsd_ha_node1'][0] }}"
      when:
        - vsd_cluster | default(false)
