- debug: var=file_total_size

- name: Set sysbench prepare command for testing
  set_fact:
    sysbench_prepare_command: "sysbench --test=fileio --file-total-size=10G prepare"

- debug: var=sysbench_prepare_command

- name: Prepare sysbench to run
  shell: "{{ sysbench_prepare_command }}"

- name: Run sysbench test
  shell: "sysbench --test=fileio --file-total-size=10G --file-test-mode=rndrw --init-rng=on --max-time=300 --max-requests=0 run"
  register: sysbench_output

- debug: var=sysbench_output.stdout

- name: Get IOPS
  set_fact:
    IOPS: "{{ sysbench_output.stdout | regex_search('\\d.*(Requests\\/sec)') }}"

- debug: var=IOPS

- name: Set IOPS value
  set_fact:
    IOPS_val: "{{ IOPS | regex_search('\\d*\\.\\d*') }}"

- debug: var=IOPS_val

- name: Verify IOPS value meets the specified threshold
  assert:
    that: "IOPS_val|int >= {{ iops_target_threshold }}"
    msg: "IOPS value does not meet the specified target threshold"

- name: Cleanup sysbench files
  shell: "sysbench --test=fileio --file-total-size=10G cleanup"
