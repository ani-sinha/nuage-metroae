- block:

  - name: Measure latency between current and other VSD
    shell: nping --tcp -p 3306 -c 10 {{ other_node }} | grep 'Max rtt:*' | cut -dm -f1 | sed 's/Max rtt://1'
    register: measured_rtt_latency

  - name: Check if latency lower than required
    assert:
      that: "(measured_rtt_latency.stdout | int) < max_rtt_latency"
      msg: >-
        "RTT Latency between {{ other_node }} and {{ current_node }} is higher than required.
        Quitting install. Recommended to use RTT cluster latency less than {{ max_rtt_latency }} milliseconds
        To ignore this error, set ignore_errors_rtt_test to true or adjust the value of max_cluster_rtt_latency 
        or max_active_standby_rtt_latency in common.yml file in your deployment and rerun the MetroAE command again.
        To skip latency tests set skip_vsd_cluster_rtt_test to true"
    ignore_errors: "{{ ignore_errors_rtt_test | default(false) }}"

  - name: Store the latency result object
    set_fact:
      single_result: {
        src: '{{ current_node }}',
        dst: '{{ other_node }}',
        latency: '{{ measured_rtt_latency.stdout }}'
      }

  when: delegate_node is not defined

- block:

  - name: Measure latency between current and other VSD
    shell: nping --tcp -p 3306 -c 10 {{ other_node }} | grep 'Max rtt:*' | cut -dm -f1 | sed 's/Max rtt://1'
    register: measured_rtt_delegate_latency
    delegate_to: "{{ delegate_node | default ('NONE') }}"

  - name: Check if latency lower than required
    assert:
      that: "(measured_rtt_delegate_latency.stdout | int) < max_rtt_latency"
      msg: >-
        "RTT Latency between {{ other_node }} and {{ delegate_node }} is higher than required.
        Quitting install. Recommended to use RTT cluster latency less than {{ max_rtt_latency }} milliseconds
        To ignore this error, set ignore_errors_rtt_test to true or adjust the value of max_cluster_rtt_latency 
        or max_active_standby_rtt_latency in common.yml file in your deployment and rerun the MetroAE command again.
        To skip latency tests set skip_vsd_cluster_rtt_test to true"
    ignore_errors: "{{ ignore_errors_rtt_test | default(false) }}"

  - name: Store the latency result object
    set_fact:
      single_result: {
        src: '{{ delegate_node }}',
        dst: '{{ other_node }}',
        latency: '{{ measured_rtt_delegate_latency.stdout }}'
      }

  when: delegate_node is defined

- name: Add the result to previous results
  set_fact:
    latency_test_results: '{{latency_test_results + [single_result]}}'
