- name: Set major or minor upgrade flag
  include_role:
    name: common
    tasks_from: set-major-minor-versions.yml

- block:

  - name: Restart Jboss
    shell: "monit restart jboss"
    when:
     - upgrade_major_or_minor == 'minor'
     - not inplace_upgrade | default(false)
     - inventory_hostname in groups['primary_vsds']

  - block:
    - name: Grab the VSD version
      shell: grep -ir "VSD_VERSION=" /etc/profile.d/vsd-banner.sh | awk -F "=" '{print $2}'
      register: vsd_version
      run_once: true

    - name: Grab the VSD build
      shell: grep -ir "VSD_BUILD=" /etc/profile.d/vsd-banner.sh | awk -F "=" '{print $2}'
      register: vsd_build
      run_once: true

    - name: Set upgrade complete flag
      shell: {{ upgrade_complete_flag_command }}
      register: result
      until: result.rc == 0
      retries: 40
      delay: 30
      when: inventory_hostname == groups['primary_vsds'][0]

    - name: Turn on API on vsd's for major upgrade
      shell: "{{ turn_on_api_command }}"
      when: upgrade_major_or_minor == 'major'

    when: not inplace_upgrade | default(false)

  - import_tasks: check_monit_status.yml
    when: not inplace_upgrade | default(false)

  remote_user: "{{ vsd_custom_username | default(vsd_default_username) }}"
  become: "{{ 'no' if vsd_custom_username | default(vsd_default_username) == 'root' else 'yes' }}"
  vars:
    ansible_become_pass: "{{ vsd_custom_password | default(vsd_default_password) }}"
