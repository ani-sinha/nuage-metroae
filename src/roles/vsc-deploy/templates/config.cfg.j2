exit all
configure

#--------------------------------------------------
echo "System Configuration"
#--------------------------------------------------
    system
        name {{ system_name | default(inventory_hostname) }}
        time
            ntp
            {% for ntp_server in ntp_server_list %}
                server {{ ntp_server }}
            {% endfor %}
                no shutdown
            exit
        exit
    exit
#--------------------------------------------------
#echo "System Security Configuration"
#--------------------------------------------------
    system
        security
            tls-profile "vsc-tls-profile" create
                shutdown
            exit
            {% if enable_hardening | default(True) %}
            ssh
                client-cipher-list protocol-version 1
                    no cipher 200 # name 3des
                    no cipher 205 # name blowfish
                    no cipher 210 # name des
                exit
                client-cipher-list protocol-version 2
                    cipher 190 name aes256-ctr
                    cipher 192 name aes192-ctr
                    cipher 194 name aes128-ctr
                    no cipher 200 # name aes128-cbc
                    no cipher 205 # name 3des-cbc
                    no cipher 210 # name blowfish-cbc
                    no cipher 215 # name cast128-cbc
                    no cipher 220 # name arcfour
                    no cipher 225 # name aes192-cbc
                    no cipher 230 # name aes256-cbc
                    no cipher 235 # name rijndael-cbc
                exit
                server-cipher-list protocol-version 1
                    no cipher 200 # name 3des
                    no cipher 205 # name blowfish
                exit
                server-cipher-list protocol-version 2
                    cipher 190 name aes256-ctr
                    cipher 192 name aes192-ctr
                    cipher 194 name aes128-ctr
                    no cipher 200 # name aes128-cbc
                    no cipher 205 # name 3des-cbc
                    no cipher 210 # name blowfish-cbc
                    no cipher 215 # name cast128-cbc
                    no cipher 220 # name arcfour
                    no cipher 225 # name aes192-cbc
                    no cipher 230 # name aes256-cbc
                    no cipher 235 # name rijndael-cbc
                exit
                client-mac-list
                    mac 200 name hmac-sha2-512
                    mac 210 name hmac-sha2-256
                    mac 215 name hmac-sha1
                    no mac 220 # name hmac-sha1-96
                    no mac 225 # name hmac-md5
                    no mac 230 # name hmac-ripemd160
                    no mac 235 # name hmac-ripemd160-openssh-com
                    no mac 240 # name hmac-md5-96
                exit
                server-mac-list
                    mac 200 name hmac-sha2-512
                    mac 210 name hmac-sha2-256
                    mac 215 name hmac-sha1
                    no mac 220 # name hmac-sha1-96
                    no mac 225 # name hmac-md5
                    no mac 230 # name hmac-ripemd160
                    no mac 235 # name hmac-ripemd160-openssh-com
                    no mac 240 # name hmac-md5-96
                exit
                preserve-key
            exit
            {% endif %}
        exit
    exit
#--------------------------------------------------
echo "Virtual Switch Controller Configuration"
#--------------------------------------------------
    vswitch-controller
        xmpp-server "{{ xmpp.username }}@{{ vsd_fqdn }}"
    exit

#--------------------------------------------------
echo "Router (Network Side) Configuration"
#--------------------------------------------------
    router
        {% if control_ip is defined and control_netmask_prefix is defined %}
        interface "control"
            {% if internal_ctrl_ip is defined %}
            address {{ internal_ctrl_ip }}/{{ control_netmask_prefix }}
            {% else %}
            address {{ control_ip }}/{{ control_netmask_prefix }}
            {% endif %}
            no shutdown
        exit
        {% endif %}
        interface "system"
        {% if system_ip is defined %}
            address {{ system_ip }}/32
            no shutdown
        {% else %}
            shutdown
        {% endif %}
        exit
        {% if as_number %}
        autonomous-system {{ as_number }}
        {% endif %}
        {% if system_ip is defined %}
        router-id {{ system_ip }}
        {% endif %}
#--------------------------------------------------
##echo "Static Route Configuration"
###--------------------------------------------------
        {% for vsc_item in groups['vscs'] %}
          {% if vsc_item != inventory_hostname %}
            {% if hostvars[vsc_item].system_ip is defined %}
              {% if hostvars[vsc_item].system_ip != system_ip | default('') %}
        static-route {{ hostvars[vsc_item].system_ip }}/32 next-hop {{ hostvars[vsc_item].control_ip }}
              {% endif %}
            {% endif %}
          {% endif %}
        {% endfor %}
        {% if internal_data_gateway_ip is defined %}
        static-route 0.0.0.0/0 next-hop {{ internal_data_gateway_ip }}
        {% endif %}
    exit

#--------------------------------------------------
echo "Service Configuration"
#--------------------------------------------------

        {% for vprn_obj in vprn_object_list %}
    service
        vprn {{ vprn_obj.vlan }} customer 1 create
            interface "control" create
            exit
        exit
        vprn {{ vprn_obj.vlan }} customer 1 create
            route-distinguisher {{ as_number }}:{{ vprn_obj.vlan }}
            interface "control" create
                {% if vprn_obj.ipaddr != "" %}
                address {{ vprn_obj.ipaddr }}/{{ vprn_obj.netmask_length }}
                {% else %}
                address {{ control_ip }}/{{ control_netmask_prefix }}
                {% endif %}
                sap A/2:{{ vprn_obj.vlan }} create
                exit
            exit

        {% if vprn_obj.ipaddr != "" %}
        static-route 0.0.0.0/0 next-hop {{ vprn_obj.ipaddr | ipsubnet(vprn_obj.netmask_length, 0) | ipaddr('next_usable') }}
        {% else %}
        static-route 0.0.0.0/0 next-hop {{ control_ip | ipsubnet(control_netmask_prefix, 0) | ipaddr('next_usable') }}
        {% endif %}

            ntp
                no shutdown
            exit
            no shutdown
        exit
    exit
        {% endfor %}

#--------------------------------------------------
##echo "BGP Configuration"
###--------------------------------------------------
    router
        bgp
            connect-retry 2
            min-route-advertisement 1
            outbound-route-filtering
                extended-community
                    send-orf
                exit
            exit
            group "internal"
                type internal
                {% for vsc_item in groups['vscs'] %}
                  {% if vsc_item != inventory_hostname %}
                    {% if hostvars[vsc_item].system_ip is defined %}
                      {% if hostvars[vsc_item].system_ip != system_ip %}
                neighbor {{ hostvars[vsc_item].system_ip }}
                exit
                      {% endif %}
                    {% endif %}
                  {% endif %}
                {% endfor %}
                family evpn
            exit
        exit
    exit
exit
exit all
