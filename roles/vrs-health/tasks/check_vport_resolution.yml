---
# Check proper resolution of VPorts (if any exist) on VRS
- name: get list of vms
  virt: command=list_vms state=running
  register: virt_vms

- name: Get TAP Interfaces for each VM
  shell: "virsh domiflist {{ item }} | awk '/tap.*/ { print $1 }'"
  with_items: "{{ virt_vms.list_vms }}"
  register: tapinterfaces
  changed_when: false

- name: Check if corresponding Interface and Port exist on OVS
  shell: "ovs-vsctl show | grep -Pzl '(?s)Port \"{{item}}\"\\n.*Interface \"{{item}}\"'"
  with_items: "{{ tapinterfaces.results | map(attribute='stdout') | list }}"
  changed_when: false

- name: Check if EVPN got resolved for each VPort
  shell: "ovs-appctl vm/port-show | grep '{{item}}' -A 2 | grep -q 'evpn_id: 0'"
  with_items: "{{ tapinterfaces.results | map(attribute='stdout') | list}}"
  register: results
  changed_when: false
  failed_when: results.rc ==  0

