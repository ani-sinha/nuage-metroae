---

- block:

  - name: Renew standalone VSD certificate
    command: /opt/vsd/bin/vsd-renew-certs.sh

  - name: Restart ejabberd
    command: monit restart ejabberd
    when: require or allow tls mode

  - name: wait for ejabberd to come up
    monit_waitfor_service:
      name: ejabberd
      timeout_seconds: 600
      test_interval_seconds: 30

  - name: Stop VSD core service
    shell: monit stop -g vsd-core

  - name: Pause for processes to exit
    pause:
      seconds: 20

  - name: Restart the VSD core service
    shell: monit start -g vsd-core

  - name: Wait VSD core to start
    monit_waitfor_service:
      name: vsd-core
      timeout_seconds: 600
      test_interval_seconds: 30

  - name: Restart stats if enabled
    shell: monit restart -g vsd-stats

  when:
    - vsd_sa_or_ha is match ('sa')
    - not vsd_standby_cluster | default(False)

- block:

  - name: Renew primary VSD cert
    command: /opt/vsd/bin/vsd-renew-certs.sh
    with_items: vsd1

  - name: Renew other 2 VSD certs
    command: /opt/vsd/bin/vsd-renew-certs.sh -1 vsd-1.mydomain.com
    with_items: vsd2 and vsd3

  - name: Restart ejabberd
    command: monit restart ejabberd
    when: require or allow tls mode

  - name: wait for ejabberd to come up
    monit_waitfor_service:
      name: ejabberd
      timeout_seconds: 600
      test_interval_seconds: 30

  - name: Stop VSD core service
    shell: monit stop -g vsd-core

  - name: Pause for processes to exit
    pause:
      seconds: 20

  - name: Restart the VSD core service
    shell: monit start -g vsd-core

  - name: Wait VSD core to start
    monit_waitfor_service:
      name: vsd-core
      timeout_seconds: 600
      test_interval_seconds: 30

  - name: Restart stats if enabled
    shell: monit restart -g vsd-stats

  when:
    - vsd_sa_or_ha is match ('ha')
    - not vsd_standby_cluster | default(False)

- block:

  - name: Renew primary VSD cert
    command: /opt/vsd/bin/vsd-renew-certs.sh
    with_items: vsd4

  - name: Renew other 2 VSD certs
    command: /opt/vsd/bin/vsd-renew-certs.sh -1 vsd-4.mydomain.com
    with_items: vsd5 and vsd6

  - name: Restart ejabberd
    command: monit restart ejabberd
    when: require or allow tls mode
    with_items: "{{ groups['standby_vsds'] }}"

  - name: wait for ejabberd to come up
    monit_waitfor_service:
      name: ejabberd
      timeout_seconds: 600
      test_interval_seconds: 30
    with_items: "{{ groups['standby_vsds'] }}"

  when: vsd_standby_cluster | default(False)
