---
- hosts: nsgvs
  gather_facts: no
  serial: 1
  pre_tasks:
    - name: Set zfb constants
      set_fact:
        zfb_constants:
          proxy_user: 'proxy'
          useTwoFactor: False
          upgradeAction: NONE
          network_port_type: NETWORK
          access_port_type: ACCESS
          iso_params:
            mediaType: ISO
            associatedEntityType: nsgatewaytemplate
            NSGType: ANY
            associatedEntityID: update
  tasks:

    - name: Create local temp directory
      tempfile:
        state: directory
        path: "{{ lookup('env', 'TMPDIR') | default('/tmp/', true) }}"
      delegate_to: localhost
      register: mktemp_output

    - name: Generate ISO file
      create_zfb_profile:
        nsgv_path: "{{ mktemp_output.path }}"
        fact_name: nsgv_already_configured
        vsd_license_file: "{{ vsd_license_file }}"
        vsd_auth: "{{ vsd_auth }}"
        zfb_constants: "{{ zfb_constants }}"
        zfb_proxy_user: "{{ zfb_proxy_user }}"
        zfb_nsg: "{{ zfb_nsg }}"
        zfb_ports: "{{ zfb_ports }}"
        zfb_nsg_infra: "{{ zfb_nsg_infra }}"
        zfb_vsc_infra: "{{ zfb_vsc_infra }}"
      delegate_to: localhost

    - name: Create subdirectory for unzipped files
      file:
        name: "/home/caso/nsg_iso/{{inventory_hostname}}"
        state: directory
        mode: 0775
      delegate_to: localhost
      run_once: true

    - name: Copy image files
      copy: 
        src={{ mktemp_output.path }}/user_image.iso
        dest=/home/caso/nsg_iso/{{inventory_hostname}}/user_image.iso
        owner=caso
        group=caso
      delegate_to: localhost

- hosts: localhost
  gather_facts: no
  become: yes
  tasks:
    - name: Add user as caso for qemuconf
      lineinfile:
        dest: /etc/libvirt/qemu.conf
        line: "{{ item }}"
      with_items: 
        - 'user = "caso"'
        - 'group = "caso"'

    - name: Restart service libvirt
      service:
        name: libvirtd
        state: restarted
