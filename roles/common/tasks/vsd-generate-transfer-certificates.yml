- name: Get VSD version
  shell: echo $VSD_VERSION
  register: vsd_version
  delegate_to: "{{ groups['vsds'][0] }}"
  
- name: Create and transfer certs from VSD
  shell: "/bin/sshpass -p{{ certificate_password }} /opt/vsd/ejbca/deploy/certMgmt.sh -a generate -u {{ certificate_username }} -c {{ commonName }} -o csp -f pem -t {{ certificate_type }} -d {{ inventory_hostname }} -s {{ scp_user }}@{{ inventory_hostname }}:{{ scp_location }} {{ additional_parameters }} "
  remote_user: "{{ vsd_username }}"
  delegate_to: "{{ vsd_fqdn }}"
  when: "'4.0.4' not in vsd_version "

- name: Create and transfer certs from 4.0.4 VSD
  shell: "/bin/sshpass -p{{ certificate_password }} /opt/vsd/ejbca/deploy/certMgmt.sh -a generate -u {{ certificate_username }} -c {{ commonName }} -o csp -f pem -t {{ certificate_type }} -d {{ inventory_hostname }} -s {{ scp_user }}@{{ inventory_hostname }}:{{ scp_location }}   -n VSPCA {{ additional_parameters }} "
  remote_user: "{{ vsd_username }}"
  delegate_to: "{{ vsd_fqdn }}"
  when: "'4.0.4' in vsd_version "
  
