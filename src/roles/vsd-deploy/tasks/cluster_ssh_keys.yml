- block:

  - name: Generate SSH keys for nodes 2 and 3, install case
    user:
      name: "vsd"
      generate_ssh_key: yes
    register: ssh_key_list
    delegate_to: "{{ item }}"
    with_items:
      - "{{ second_cluster_node_to_install }}"
      - "{{ third_cluster_node_to_install }}"

  - name: Add SSH keys to authorized_keys file on this node
    authorized_key:
        key: "{{ item.ssh_public_key }}"
        user: "vsd"
    with_items:
      - "{{ ssh_key_list.results }}"

  - name: Change owner and permissions of VSD authorized keys file on node 1
    file:
      path: /home/vsd/.ssh/authorized_keys
      owner: vsd
      group: hadoopusers
      mode: 0640

  when:
    - inventory_hostname == first_cluster_node_to_install
    - not nuage_upgrade | default(False)

- block:

  - name: Generate SSH keys for the second node, upgrade case
    user:
      name: "vsd"
      generate_ssh_key: yes
    register: ssh_key
    delegate_to: "{{ second_cluster_node_to_install }}"

  - name: Add SSH keys to authorized_keys file on this node
    authorized_key:
        key: "{{ ssh_key.ssh_public_key }}"
        user: "vsd"

  - name: Change owner and permissions of VSD authorized keys file
    file:
      path: /home/vsd/.ssh/authorized_keys
      owner: vsd
      group: hadoopusers
      mode: 0640

  when:
    - inventory_hostname == first_cluster_node_to_install
    - nuage_upgrade | default(False)

- block:

  - name: Generate SSH key for this node
    user:
      name: "vsd"
      generate_ssh_key: yes
    register: ssh_key

  - block:

    - name: Install pexpect module via pip
      pip: name=pexpect state="present"

    - local_action: copy content={{ ssh_key.ssh_public_key }} dest=/tmp/authorized_keys_temp

    - name: Copy authorized file to vsd custom user home directory
      expect:
        command: "scp /tmp/authorized_keys_temp {{ vsd_custom_username }}@{{ hostvars[groups['vsd_ha_node2'][0]]['mgmt_ip'] }}:/home/{{ vsd_custom_username }}/.ssh/authorized_keys"
        responses:
          (?i)yes: "yes"
          (?i)password: "{{ vsd_custom_password }}"
        timeout: 720
      delegate_to: localhost
      no_log: true

    - name: Remove temporary copy of authorized_keys file
      file: path=tmp/authorized_keys_temp state=absent
      delegate_to: localhost

    - name: change file permissions
      shell: |
        set timeout 100
        spawn ssh {{ vsd_custom_username }}@{{ hostvars[groups['vsd_ha_node2'][0]]['mgmt_ip'] }}
        expect "password:"
        send "{{ vsd_custom_password }}\n"
        chmod 0640 /home/{{ vsd_custom_username }}/.ssh/authorized_keys
        chown vsd:hadoopusers /home/{{ vsd_custom_username }}/.ssh/authorized_keys
        exit 0
        delegate_to: localhost

    when: vsd_custom_username is defined
  

  - block:

    - name: Add this node's SSH key to authorized_keys file on first node
      authorized_key:
          key: "{{ ssh_key.ssh_public_key }}"
          user: "vsd"
      delegate_to: "{{ first_cluster_node_to_install }}"

    - name: Change owner and permissions of VSD authorized keys file
      file:
        path: /home/vsd/.ssh/authorized_keys
        owner: vsd
        group: hadoopusers
        mode: 0640
      delegate_to: "{{ first_cluster_node_to_install }}"

    when: vsd_custom_username is not defined

  when:
    - inventory_hostname == third_cluster_node_to_install
    - nuage_upgrade | default(False)
