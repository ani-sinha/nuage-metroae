- block:

  - name: Set fact for default from address
    set_fact:
      default_from_address: "metroae@{{ ansible_hostname }}"

  - name: Email health report files
    mail:
      host: "{{ smtp_server }}"
      port: "{{ smtp_port | default(25) }}"
      from: "{{ from_address | default(default_from_address) }}"
      to: "{{ destination_addresses }}"
      subject: "{{ email_subject }}"
      attach: "{{ attachments }}"
      body: "{{ email_body }}"
      username: "{{ smtp_username }}"
      password: "{{ smtp_password }}"
    delegate_to: localhost

  when: email_health_results | default(False)
