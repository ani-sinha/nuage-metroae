---
- name: Set management interface ip address
  set_fact:
    mgmt_ip: "{{ mgmt_ip_and_prefix.split('/')[0] }}"

- name: Set management interface netmask
  set_fact:
    mgmt_netmask_prefix: "{{ mgmt_ip_and_prefix.split('/')[1] }}"

- name: Set control interface ip address
  set_fact:
    ctrl_ip: "{{ control_ip_and_prefix.split('/')[0] }}"

- name: Set control interface netmask
  set_fact:
    ctrl_netmask_prefix: "{{ control_ip_and_prefix.split('/')[1] }}"

- include_role:
    name: check-node-reachability

- block:
  - debug: var=vsc_creds

  - name: Get output of 'show version'
    sros_command:
      commands:
        - show version
      provider: "{{ vsc_creds }}"
    ignore_errors: yes
    delegate_to: localhost
    register: sh_version

  when: node_reachable

# TODO
# Check sh_version against image version

- name: Set fact for VSC present
  set_fact:
    node_present: "{{ node_reachable and sh_version is defined }}"

- include: kvm.yml
  when: target_server_type | match("kvm")
  tags:
    - vsc
    - vsc-predeploy

- include: heat.yml
  when: target_server_type | match("heat")
  tags:
    - vsc
    - heat
    - vsc-predeploy

- include: vcenter.yml
  when: target_server_type | match("vcenter")
  tags:
    - vsc
    - vsc-predeploy
