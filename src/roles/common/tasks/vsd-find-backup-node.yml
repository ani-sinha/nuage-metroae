- name: Check the number of certificates installed on vsd node
  shell:  ls -1 /opt/vsd/ejbca/p12/*`hostname -d`*.pem | wc -l
  ignore_errors: True
  register: count_files

- name: Set fact for number of certificates found
  set_fact:
    certs_count: "{{count_files.stdout | int | default(0)}}"

- name: Check type of certs_count
  debug:
    msg: "{{ certs_count | type_debug }}"

- block:
  - debug: var=hostvars['localhost'].max_certs_count

  - name: Check type of max_certs_count
    debug:
      msg: "{{ hostvars['localhost'].max_certs_count | type_debug }}"

  - name: Test int filter on max certs count
    set_fact:
      max_certs_count_int: "{{ hostvars['localhost'].max_certs_count | int }}"

  - debug: var=max_certs_count_int

  - name: Check type after int filter
    debug:
      msg: "{{ max_certs_count_int | type_debug }}"

  when: hostvars['localhost'].max_certs_count is defined

- name: Check if the node has maximum certificates in the cluster
  set_fact:
    vsd_backup_node: "{{inventory_hostname}}"
    max_certs_count: "{{ certs_count }}"
  delegate_to: localhost
  delegate_facts: True
  when: certs_count | int > (hostvars['localhost'].max_certs_count | default(0) | int)
