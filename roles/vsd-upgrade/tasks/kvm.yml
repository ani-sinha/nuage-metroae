---
- block:
  - name: Shutdown VSD Node1 and Node3
    virt: name="{{ inventory_hostname }}"
        state=destroyed
        uri=qemu:///system
    delegate_to: "{{ target_server }}"
 
  - name: Undefine VSD Node1 and Node3
    virt: name="{{ inventory_hostname }}"
          command=undefine
          uri=qemu:///system
    delegate_to: "{{ target_server }}"
    remote_user: root

  - name: Deploy VSD Node1 and Node3 with new version
    include_role:
      name: vsd-predeploy

  - name: Wait for VSD ssh to be ready
    local_action:
      module: wait_for
      port: "22"
      host: "{{ interfaces.mgmt.ip }}"
      search_regex: OpenSSH
      delay: 1

  - include: upgrade_vsd.yml 
  when: inventory_hostname == groups['vsds'][0] or inventory_hostname == groups['vsds'][2]
