---
- name: Gathering info on VM
  connection: local
  vmware_guest:
    hostname: "{{ target_server }}"
    username: "{{ vcenter.username }}"
    password: "{{ vcenter.password }}"
    name: "{{ inventory_hostname }}"
    validate_certs: no
    state: gatherfacts
  register: nsgv_vm_facts
  ignore_errors: yes

- debug: var=nsgv_vm_facts verbosity=1

- name: Verify the NSGV VM does not exist
  assert: 
    that: "nsgv_vm_facts.failed"
    msg: "VM {{ inventory_hostname }} already exists, quiting"

- name: Deploy NSGV OVA on vCenter
  connection: local
  command: >
    {{ vcenter.ovftool }}
    --acceptAllEulas
    --noSSLVerify
    --powerOn
    --machineOutput
    -dm=thin
    -ds={{ vcenter.datastore }}
    -n={{ inventory_hostname }}
    --net:"Management={{ mgmt_bridge }}"
    "{{ nsgv_ova_path }}/{{ nsgv_ova_file_name }}"
    vi://'{{ vcenter.username | urlencode }}':'{{ vcenter.password | urlencode }}'@{{ target_server }}/{{ vcenter.datacenter }}/host/{{ vcenter.cluster }} 
  when: "'.ova' in nsgv_ova_file_name"


- name: Waiting 120 seconds to make sure the Stats VM is up
  pause: 
    seconds: 120

- name: Gathering info on VM
  connection: local
  vmware_guest:
    hostname: "{{ target_server }}"
    username: "{{ vcenter.username }}"
    password: "{{ vcenter.password }}"
    name: "{{ inventory_hostname }}"
    validate_certs: no
    state: gatherfacts
  register: nsgv_vm_facts

- debug: var=nsgv_vm_facts verbosity=1

- name: Verify the nsgv VM came up correctly
  assert: 
    that: 
      - "nsgv_vm_facts.instance.hw_guest_id is defined"
      - "not nsgv_vm_facts.instance.hw_guest_id is none"
      - "not nsgv_vm_facts.instance.hw_guest_id == ''"
    msg: "Stats VM {{ inventory_hostname }} did not come up after two minutes"

