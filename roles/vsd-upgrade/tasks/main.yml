---
- name: Perform vsd database backup
  include_role:
    name: vsd-dbbackup
  when: inventory_hostname in groups['vsd_ha_node1']

- name: Decouple VSD node1 and node3
  vars:
    report_filename: vsd_decluster_report.txt
  include_role:
    name: vsd-decouple
  when:
    - inventory_hostname in groups['vsds']
    - vsd_sa_or_ha == 'ha'

- name: Stop vsd services gracefully
  include_role:
    name: vsd-services-stop
  when:
    - inventory_hostname in groups['vsd_ha_node1'] or inventory_hostname in groups['vsd_ha_node3']
    - vsd_sa_or_ha == 'ha'

- name: Shutdown/Destroy Current vsd node(s)
  include_role: 
    name: vsd-destroy
  vars:
    preserve_vsd: True

- name: Deploy VSD nodes with new version
  include_role:
    name: vsd-predeploy

- name: Wait for VSD ssh to be ready
  local_action:
    module: wait_for
    port: "22"
    host: "{{ mgmt_ip }}"
    search_regex: OpenSSH
    delay: 1

- include: vsd_post_upgrade_helper.yml

- include: copy_backup_files.yml

#TODO: 
#- name: Compare network information of VSD's across pre-uppgrade and upgrade

- name: Install VSD on new node(s)
  include_role:
    name: vsd-deploy

- name: Pause to wait for VSD processes to come up
  pause:
    minutes: 5
