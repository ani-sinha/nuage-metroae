
- block:

  - name: Set VSD KVM image location
    include_role:
      name: common
      tasks_from: find-image.yml
    vars:
      pattern: VSD-*.qcow2
    when: vsds | map(attribute='target_server_type') | list | issuperset(["kvm"]

  - name: Set VSD vCenter image location
    include_role:
      name: common
      tasks_from: find-image.yml
    vars:
      pattern: VSD-*.ova
    when: vsds | map(attribute='target_server_type') | list | issuperset(["vcenter"]

  - name: Find name of VSD Migration ISO File
    include_role:
      name: common
      tasks_from: find-file.yml
    vars:
      pattern: "VSD-migration-scripts-*.iso"

  - name: Register VSD migration iso file with proper path and script locations for use in other playbooks
    set_fact:
      vsd_migration_iso_path: "{{ file_path }}"
      vsd_migration_iso_file_name: "{{ file_name }}"

  - name: Register that upgrade files are missing
    set_fact:
      missing_image_file: true
    when: missing_file | default(True)

  - name: Verify that vsd_fqdn_global is defined
    assert:
      that:
        - "vsd_fqdn_global is defined"
      msg: "vsd_fqdn_global must be defined. See common.yml."

  - name: Verify VSD management gateway is in correct IP range
    include_role:
      name: common
      tasks_from: check-ip-in-range.yml
    vars:
      ip_address: "{{ item.mgmt_gateway }}"
      netaddr: "{{ item.mgmt_ip }}"
      netmask: "{{ item.mgmt_ip_prefix }}"
    with_items: "{{ vsds }}"

  - name: Create host_vars files for vsd
    template: src=vsd.j2 backup=no dest={{ inventory_dir }}/host_vars/{{ item.hostname }}
    with_items: "{{ vsds }}"

  - name: Verify VSD DNS entries exist at server {{ dns_server_list[0] }}, and hostnames map to their IPs
    include_tasks: check-dns.yml
    with_items: "{{ vsds }}"
    when: dns_server_list

  when: vsds is defined and vsds
