- name: Prepare disk performance test (ignoring errors)
  shell: "sysbench --test=fileio --file-total-size={{ disk_performance_file_total_size }} prepare"
  register: disk_performance_test_prepare
  ignore_errors: true

- name: Run disk performance test (ignoring errors)
  shell: "sysbench --test=fileio --file-total-size={{ disk_performance_file_total_size }} --file-test-mode=rndrw --init-rng=on --max-time=300 --max-requests=0 run"
  register: disk_performance_test_output
  ignore_errors: true
  when: disk_performance_test_prepare.rc == 0

- name: Cleanup disk performance test files (ignoring errors)
  shell: "sysbench --test=fileio --file-total-size={{ disk_performance_file_total_size }} cleanup"
  register: disk_performance_test_cleanup
  ignore_errors: true

- name: Verify that disk performance test preparation succeeded
  fail:
    msg: "There was an error during the preparation process. This may have been caused due to insufficient disk space on VSD."
  when: disk_performance_test_prepare.rc != 0

- name: Verify that disk performance test ran to completion without error
  fail:
    msg: "There was an unexpected error during the sysbench run."
  when: disk_performance_test_output.rc != 0

- name: Verify that disk performance test files were deleted without error
  fail:
    msg: "There was an error when cleaning up the disk performance test files. You may need to clean up the files manually or execute the cleanup command again on the target device."
  when: disk_performance_test_cleanup.rc != 0

- block:

  - name: Set fact for disk performance test result
    set_fact:
      disk_performance_val: "{{ disk_performance_test_output.stdout | regex_search('\\d.*(Requests\\/sec)') | regex_search('\\d*\\.\\d*') }}"

  - name: Verify disk performance value meets the specified threshold
    assert:
      that: "disk_performance_val|int >= {{ disk_performance_minimum_threshold }}"
      msg: "Disk performance (IOPS) value does not meet the specified minimum threshold"

  when:
    - disk_performance_test_prepare.rc == 0
    - disk_performance_test_output.rc == 0
