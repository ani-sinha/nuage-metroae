- name: Get infra server details from OS server facts
  os_server_facts:
    auth:
      "{{ os_auth }}"
    server: "{{ infra_server_name }}"
  register: infra_server
  delegate_to: "{{ ansible_deployment_host }}"

- name: Set DNS/NTP server ip
  set_fact:
    infra_ip: "{{ infra_server['ansible_facts']['openstack_servers'][0]['private_v4'] }}"

- block:
  - name: Update DNS entries
    lineinfile:
      line: "{{ vsc_mgmt_ip }}  {{ inventory_hostname }}"
      dest: "/etc/hosts"
    delegate_to: "{{ infra_ip }}"
    remote_user: "root"

  - name: Restart DNS service
    shell: service dnsmasq restart
    delegate_to: "{{ infra_ip }}"

  remote_user: "root"
