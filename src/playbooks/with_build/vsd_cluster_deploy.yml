---
- hosts: localhost
  tasks:
    - name: Set VSD numbering for cluster install
      set_fact:
        first_cluster_node_to_install: "{{ groups['vsds'][0] }}"
        second_cluster_node_to_install: "{{ groups['vsds'][1] }}"
        third_cluster_node_to_install: "{{ groups['vsds'][2] }}"
      when: vsd_cluster | default(false)
    - name: Set VSD numbering for standby install
      set_fact:
        first_standby_cluster_node: "{{ groups['vsds'][3] }}"
        second_standby_cluster_node: "{{ groups['vsds'][4] }}"
        third_standby_cluster_node: "{{ groups['vsds'][5] }}"
      when: vsd_cluster | default(false)

- hosts: localhost
  tasks:
    - name: Set VSDs length
      set_fact: 
        vsd_length: "{{ vsds|length }}"

- hosts: localhost
  tasks:
    - name: Debug VSD length
      debug: var=vsd_length verbosity=1

- hosts: primary_cluster
  become: yes
  remote_user: "{{ vsd_default_username }}"
  tasks:
    - name: Run vsd-prepare-replication-master-cluster
      command: "/opt/vsd/bin/vsd-prepare-replication-master-cluster.sh"
      when: vsd_cluster | default(false)

    - name: Run vsd-prepare-replication-master on first cluster
      command: "/opt/vsd/bin/vsd-prepare-replication-master.sh -a {{ first_standby_cluster_node }} -b {{ second_standy_cluster_node }} -c {{ third_standby_cluster_node }}"
      when:
        - vsd_cluster | default(false)
        - inventory_hostname == first_cluster_node_to_install

- hosts: standby_cluster
  become: yes
  remote_user: "{{ vsd_default_username }}"
  tasks:
    - name: Create data directory on first vm of standby
      command: "mkdir /opt/vsd/data"
      when:
        - vsd_cluster | default(false)
        - inventory_hostname == first_standby_cluster_node

- hosts: primary_cluster
  become: yes
  remote_user: "{{ vsd_default_username }}"
  tasks:
    - name: Transfer data from /tmp/backup/ to data folder
      command: "scp /tmp/backup/* root@{{groups['vsds'][3].hostname}}:/opt/vsd/data/"
      when:
        - vsd_cluster | default(false)
        - inventory_hostname == first_cluster_node_to_install

- hosts: standby_cluster
  become: yes
  remote_user: "{{ vsd_default_username }}"
  tasks:
    - name: Install VSD software on the first backup cluster node (Can take 20 minutes)
      command: "/opt/vsd/vsd-install.sh -t 1 -a {{ first_standby_cluster_node }} -b {{ first_standby_cluster_node }} -c {{first_standby_cluster_node}} -x {{vsd_fqdn}} -y"
      when:
        - vsd_cluster | default(false)
        - inventory_hostname == first_standby_cluster_node

    - name: Install VSD software on the second backup cluster node (Can take 20 minutes)
      command: "/opt/vsd/vsd-install.sh -1 {{ first_standby_cluster_node }} -t 2 -x {{ vsd_fqdn }} -y"
      when:
        - vsd_cluster | default(false)
        - inventory_hostname == second_standby_cluster_node

    - name: Install VSD software on the third backup cluster node (Can take 20 minutes)
      command: "/opt/vsd/vsd-install.sh -1 {{ first_standby_cluster_node }} -t 3 -x {{ vsd_fqdn }} -y"
      when:
        - vsd_cluster | default(false)
        - inventory_hostname == third_standby_cluster_node

    - name: Run the replication script
      command: "/opt/vsd/bin/vsd-start-replication-slave -m {{ groups['vsds'][0].hostname }}"
      when:
        - vsd_cluster | default(false) 
        - inventory_hostname == first_standby_cluster_node
