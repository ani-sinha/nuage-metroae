- name: Get infra server details from OS server facts
  os_server_facts:
    auth:
      "{{ os_auth }}"
    server: "{{ infra_server_name }}"
  register: infra_server
  delegate_to: 127.0.0.1

- name: Set DNS/NTP server ip
  set_fact:
    infra_ip: "{{ infra_server['ansible_facts']['openstack_servers'][0]['private_v4'] }}"

- block:

  - name: Update DNS entries
    lineinfile:
      line: "{{ vsd_mgmt_ip }}  {{ inventory_hostname }}"
      dest: "/etc/hosts"
    delegate_to: "{{ infra_ip }}"
  
  - name: Update XMPP DNS entries for VSD cluster deployments
    lineinfile:
      line: "{{ vsd_mgmt_ip }}  xmpp.{{ dns_domain }}"
      dest: "/etc/hosts"
    delegate_to: "{{ infra_ip }}"
    when: vsd_sa_or_ha | match('ha')

  - name: Restart DNS service
    shell: service dnsmasq restart
    delegate_to: "{{ infra_ip }}"

  - name: Add a DNS server to eth0
    lineinfile:
      dest: /etc/sysconfig/network-scripts/ifcfg-eth0
      regexp: "DNS1="
      line: "DNS1={{ infra_ip  }}"

  - name: Add nameserver
    command: echo "{{ infra_ip }}" >> /etc/resolv.conf

  remote_user: "root"
