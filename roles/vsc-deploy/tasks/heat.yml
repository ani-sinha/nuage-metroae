---
- name: Get VSC details from OpenStack
  os_server_facts:
    auth:
      "{{ os_auth }}"
    server: "{{ inventory_hostname }}"
  register: vsc
  delegate_to: 127.0.0.1

- name: Set vsc mgmt ip
  set_fact:
    vsc_mgmt_ip: "{{ vsc['ansible_facts']['openstack_servers'][0]['addresses'][mgmt_interface.network][0]['addr'] }}"

- name: Set vsc control ip
  set_fact:
    vsc_control_ip: "{{ vsc['ansible_facts']['openstack_servers'][0]['addresses'][control_interface.network][0]['addr'] }}"

- name: Set VSC creds
  set_fact:
    heat_vsc_creds:
      host: "{{ vsc_mgmt_ip }}"
      username: "{{ vsc_username|default('admin') }}"
      password: "{{ vsc_password|default('admin') }}"

- name: Clean known_hosts of VSC's
  known_hosts:
    name: "{{ vsc_mgmt_ip }}"
    state: absent
  delegate_to: localhost
  no_log: True
  ignore_errors: True

- import_tasks: manage-infra-server.yml
  when: infra_server_name is defined

- name: Wait for VSC ssh to be ready
  include_role:
    name: common
    tasks_from: wait-for-ssh
  vars:
    ssh_host: "{{ vsc_mgmt_ip }}"
  tags:
    - vsc
    - vsc-deploy

- name: Load base configuration
  set_fact:
    config_lines: "{{ lookup('template', 'base-config.j2', wantlist=True) }}"

- block:
  - name: Configure VSC with base config
    sros_config:
      lines: "{{ config_lines }}"
      provider: "{{ heat_vsc_creds }}"
      save: yes

  - name: Configure Primary DNS
    sros_config:
      lines:
        - bof primary-dns "{{ dns_server_list[0] }}"
        - bof dns-domain "{{ dns_domain }}"
        - bof save "cf1:"
        - admin save
      provider: "{{ heat_vsc_creds }}"
    when:
      - dns_server_list 
      - dns_server_list[0] is defined

  - name: Configure Secondary DNS
    sros_config:
      lines:
        - bof secondary-dns "{{ dns_server_list[1] }}"
        - bof dns-domain "{{ dns_domain }}"
        - bof save "cf1:"
        - admin save
      provider: "{{ heat_vsc_creds }}"
    when:
      - dns_Server_list 
      - dns_server_list[1] is defined
  delegate_to: localhost
