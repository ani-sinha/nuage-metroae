- name: Install pexpect module via pip
  pip: name=pexpect state="present"

- local_action: copy content={{ ssh_key.ssh_public_key }} dest=/tmp/authorized_keys_temp

- name: Copy authorized file to vsd custom user home directory
  expect:
    command: "scp /tmp/authorized_keys_temp {{ username }}@{{ ssh_host }}:/home/{{ username }}/.ssh/authorized_keys"
    responses:
      (?i)yes: "yes"
      (?i)password: "{{ password }}"
    timeout: 720
  delegate_to: localhost
  no_log: true

- name: Remove temporary copy of authorized_keys file
  file: path=tmp/authorized_keys_temp state=absent
  delegate_to: localhost

- name: change file permissions
  shell: |
    set timeout 100
    spawn ssh {{ username }}@{{ ssh_host }}
    expect "password:"
    send "{{ password }}\n"
    chmod 0640 /home/{{ username }}/.ssh/authorized_keys
    chown vsd:hadoopusers /home/{{ username }}/.ssh/authorized_keys
    exit 0
    delegate_to: localhost
