---
- block:

  - name: Clean known_hosts
    known_hosts:
      name: "{{ mgmt_ip }}"
      state: absent
    delegate_to: localhost
    no_log: True


  - block:

    - name: Download pip installer
      command: curl https://bootstrap.pypa.io/get-pip.py -o get-pip.py
      delegate_to: "{{ item }}"
      with_items: "{{ groups['vsds'] }}"

    - name: Execute pip installer
      command: python get-pip.py
      delegate_to: "{{ item }}"
      with_items: "{{ groups['vsds'] }}"

    - name: Install pexpect on VSD
      pip:
        name: pexpect
      delegate_to: "{{ item }}"
      with_items: "{{ groups['vsds'] }}"

    when: yum_proxy == 'NONE'
    remote_user: "{{ vsd_username }}"

  - block:

    - name: Download pip installer through proxy
      command: curl https://bootstrap.pypa.io/get-pip.py -o get-pip.py
      delegate_to: "{{ item }}"
      environment:
        http_proxy: "{{ yum_proxy }}"
        https_proxy: "{{ yum_proxy }}"
      with_items: "{{ groups['vsds'] }}"

    - name: Execute pip installer through proxy
      command: python get-pip.py
      delegate_to: "{{ item }}"
      environment:
        http_proxy: "{{ yum_proxy }}"
        https_proxy: "{{ yum_proxy }}"
      with_items: "{{ groups['vsds'] }}"

    - name: Install pexpect on VSD through proxy
      pip:
        name: pexpect
      delegate_to: "{{ item }}"
      environment:
        http_proxy: "{{ yum_proxy }}"
        https_proxy: "{{ yum_proxy }}"
      with_items: "{{ groups['vsds'] }}"

    when: yum_proxy != 'NONE'
    remote_user: "{{ vsd_username }}"


