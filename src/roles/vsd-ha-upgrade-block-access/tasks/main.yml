---
- block:

  - name: Iptables item present
    command: "{{ item.check }}"
    register: iptables_out
    with_items: "{{ iptable_entries }}"
    ignore_errors: True

  - name: Print Iptables out
    debug: var=iptables_out

  - name: Block access to VSD1 and VSD2 from VSD3 if not already blocked
    command: "{{ item.1.create }}"
    when: item.0.rc != 0
    with_together:
      - "{{ iptables_out.results }}"
      - "{{ iptable_entries }}"

  remote_user: "{{ vsd_username | default(vsd_default_username) }}"
  become: "{{ 'no' if vsd_username | default(vsd_default_username) == 'root' else 'yes' }}"
  vars:
    ansible_become_pass: "{{ vsd_password | default(vsd_default_password) }}"
  run_once: true
