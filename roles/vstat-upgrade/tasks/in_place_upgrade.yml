- name: Disable shard allocation
  command: "{{ disable_shard }}"
  run_once: true
  when: vstat_sa_or_ha | match('ha')

- name: Perform sync flush
  commad: "{{ sync_flush }}"
  run_once: true
  when: vstat_sa_or_ha | match('ha')

- name: Disable elasticsearch serivce
  service:
    name: elasticsearch
    state: stopped

- name: Copy upgrade bundle to vstat node(s)
  copy: src={{ vstat_upgrade_srcripts_path }}/{{ vstat_upgrade_scripts_file }}
          dest=/root/
          mode=0700

- name: Execute upgrade script
  shell: "./root/{{ vstat_upgrade_scripts_file }}"

- block:
  - name: Execute VSTAT standalone script
    command: /opt/vsd/vsd-es-standalone.sh -e {{ inventory_hostname }}
    delegate_to: "{{ vsd_hostname_list }}[0]"
    register: upgrade_status
    environment:
      SSHPASS: "{{ vstat_password }}"
    run_once: true

  rescue:
    - name: Check the status of shards being processed
      command: "{{ check_shards_health }}"
      register: es_health
      until: es_health.unassigned_shards == 0
      retries: 5
      delay: 60
      run_once: true
  when: vstat_sa_or_ha | match('sa')

- block:
  - name: Execute VSTAT clustered script
    command: /opt/vsd/vsd-es-cluster-config.sh -e {{ groups['vstats'][0] }},{{ groups['vstats'][1] }},{{ groups['vstats'][2] }}
    delegate_to: "{{ vsd_hostname_list }}[0]"
    register: upgrade_status
    environment:
      SSHPASS: "{{ vstat_password }}"
    run_once: true

  rescue:
    - name: Check the status of shards being processed
      command: "{{ check_shards_health }}"
      register: es_health
      until: es_health.unassigned_shards == 0
      retries: 5
      delay: 60
      run_once: true
  when: vstat_sa_or_ha | match('ha')

- name: Restart Elasticsearch service
  service:
    name: elasticsearch
    state: restarted

- include: vstat_post_upgrade_checks.yml
  remote_user: root

- name: Execute some script
  command: "/root/nuage_elasticsearch/scripts/cluster_nuage_index_setting.sh"
  when: vstat_sa_or_ha | match('ha')
  run_once: true

- name: Delete watcher
  command: "/root/nuage_elasticsearch/scripts/delete_watcher.py"
  run_once: true

- name: Enable stats
  include_role:
    name: common
    tasks_from: vstat-enable-stats
  run_once: true
