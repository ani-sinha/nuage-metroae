- name: Set major or minor upgrade flag
  include_role:
    name: common
    tasks_from: set-major-minor-versions.yml

- block:
  - name: Get vsd_upgrade_complete flag value for minor upgrade
    command: "{{ mysql_cmd }}"
    register: upgrade_complete
    remote_user: root

  - name: Print upgrade_complete output when verbosity >= 1 
    debug: var=upgrade_complete verbosity=1
 
  - name: Set upgrade complete flag to 1 for minor upgrade on vsd
    shell: "{{ minor_upgrade }}"
    remote_user: root
    when: upgrade_complete.stdout == '0'

  - name: Restart Jboss on VSD Node1
    shell: "monit restart jboss"
    remote_user: root
  
  - include: check_monit_status.yml
  when: upgrade_major_or_minor == 'minor'

- block:
  - name: Get current version of VSD software
    command: echo $VSD_VERSION
    register: vsd_version
    remote_user: "root"

  - name: Print vsd_version output when verbosity >= 1
    debug: var=vsd_version verbosity=1

  - name: Turn on API on vsd's for major upgrade
    shell: "{{ major_upgrade }}"
    remote_user: root

  - include: check_monit_status.yml
  when: upgrade_major_or_minor == 'major'
