---
# Playbook to add a user to the Stats group
#
# Required variables:
# - vspk_auth: dict used as authentication parameter for the nuage_vspk calls
#
# It assumes the tasks to be delegated to a server that has the
# nuage vspk python module installed.

- block:

  - name: Format VSPK auth for VSPK module
    set_fact:
      vspk_auth:
        api_username: "{{ vsd_auth.username }}"
        api_password: "{{ vsd_auth.password }}"
        api_enterprise: "{{ vsd_auth.enterprise }}"
        api_url: "{{ vsd_auth.api_url }}"
        api_version: v5_0
    no_log: "{{ lookup('env', 'METROAE_NO_LOG') or 'true' }}"

  # - name: Get CSP Enterprise ID
  #   nuage_vspk:
  #     auth: "{{ vspk_auth }}"
  #     type: Enterprise
  #     command: find
  #     properties:
  #       name: "csp"
  #   register: nuage_csp_enterprise

  - name: Create stats user
    nuage_vspk:
      auth: "{{ vspk_auth }}"
      type: User
      state: present
      properties:
        userName: "{{ stats_user_user_name | default('statsuser') }}"
        firstName: "{{ stats_user_first_name | default('Statsuser') }}"
        lastName: "{{ stats_user_last_name | default('Statsuser') }}"
        email: "{{ stats_user_email | default('statsuser@csp.com') }}"
        password: "{{ stats_user_password | default(vstat_default_password) }}"
    register: stats_user

  - name: Get Stats Group
    nuage_vspk:
        auth: "{{ vspk_auth }}"
        type: Group
        parent_id: "{{ nuage_csp_enterprise.id }}"
        parent_type: Enterprise
        command: find
        properties:
          name: "Stats Group"
    register: stats_group

  - name: Assign stats user to Stats Group
    nuage_vspk:
      auth: "{{ vspk_auth }}"
      type: User
      id: "{{ stats_user.id }}"
      parent_id: "{{ stats_group.id }}"
      parent_type: Group
      state: present

  connection: local
