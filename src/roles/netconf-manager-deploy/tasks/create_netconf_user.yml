- block:

  - name: Set netconf username
    set_fact:
      netconf_username: netconfmgr

  - name: Set netconf password
    set_fact: 
      netconf_password: password

  - name: Create Netconf Manager User
    set_fact:
      netconf_manager_user:
          email: "{{ email }}"
          firstName: "{{ first_name | default('netconfmgr') }}"
          lastName: "{{ last_name | default('netconfmgr') }}"
          password: "{{ password | default('password') }}"
          netconf_user: "netconfmgr"

  - name: Create Netconf Manager User and Group
    create_netconf_manager:
      vsd_auth: "{{ vsd_auth }}"
      netconf_manager_user: "{{ netconf_manager_user }}"
    delegate_to: localhost

  - name: Create Netconf Manager Certs
    include_role:
      name: common
      tasks_from: vsd-generate-transfer-certificates
    vars:
      certificate_password: "{{ netconf_password }}"
      certificate_username: "{{ netconf_username }}"
      commonName: "{{ netconf_username }}"
      certificate_type: client
      file_type: jks
      additional_parameters: "-p {{ netconf_password }}"

  remote_user: "{{ vsd_custom_username | default(vsd_default_username) }}"
  become: "{{ 'no' if vsd_custom_username | default(vsd_default_username) == 'root' else 'yes' }}"
  vars:
    ansible_become_pass: "{{ vsd_custom_password | default(vsd_default_password) }}"
