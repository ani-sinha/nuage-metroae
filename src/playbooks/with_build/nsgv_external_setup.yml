---
- hosts: nsgvs
  gather_facts: no
  pre_tasks:
    - name: Set zfb constants
      set_fact:
        zfb_constants:
          proxy_user: 'proxy'
          useTwoFactor: False
          upgradeAction: NONE
          network_port_type: NETWORK
          access_port_type: ACCESS
          iso_params:
            mediaType: ISO
            associatedEntityType: nsgatewaytemplate
            NSGType: ANY
            associatedEntityID: update
  tasks:
    - name: Set local variable with vmname
      set_fact:
        vm_name: "{{ vmname }}"

    - name: Setup KVM on target server
      include_role:
        name: common
        tasks_from: setup-kvm

    - name: Create local temp directory
      tempfile:
        state: directory
        path: "{{ lookup('env', 'TMPDIR') | default('/tmp/', true) }}"
      delegate_to: localhost
      register: mktemp_output

    - name: Generate ISO file
      create_zfb_profile:
        nsgv_path: "{{ mktemp_output.path }}"
        fact_name: nsgv_already_configured
        vsd_license_file: "{{ vsd_license_file }}"
        vsd_auth: "{{ vsd_auth }}"
        zfb_constants: "{{ zfb_constants }}"
        zfb_proxy_user: "{{ zfb_proxy_user }}"
        zfb_nsg: "{{ zfb_nsg }}"
        zfb_ports: "{{ zfb_ports }}"
        zfb_nsg_infra: "{{ zfb_nsg_infra }}"
        zfb_vsc_infra: "{{ zfb_vsc_infra }}"
      delegate_to: localhost

    - name: Ensure NSGV has the correct configuration
      assert:
        that: "not node_running or nsgv_already_configured"
        msg: "NSGV is already running, but there was no corresponding configuration for it."

    - name: Copy the ISO image to virt images directory
      copy: src="{{ mktemp_output.path }}/user_image.iso"
            dest={{ images_path }}/{{ vmname }}
            owner={{ libvirt.user }}
            group={{ libvirt.group }}
      delegate_to: "{{ target_server }}"
      remote_user: "{{ target_server_username }}"
      become: "{{ 'no' if target_server_username == 'root' else 'yes' }}"
