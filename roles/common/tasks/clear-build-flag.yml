---
- name: Stat the file
  stat:
    path: "{{ file_name }}"
    get_md5: yes
  register: data_file

- name: 
  assert:
    that: "data_file.stat.exists"
    msg:  "Required file {{ file_name }} not found"

- name: Find md5 file
  find: path="{{ inventory_dir }}" pattern="{{ file_name }}.md5"
  register: md5_file

- name: Set variable to do build if md5 not found
  set_fact:
    do_build: True
  when: md5_file.matched == 0

- block:

  - name: Get the md5 value in the file we found
    command: "cat {{ md5_file.files[0].path }}"
    register: old_md5_string

  - block:

    - name: Set variable to do build if md5s don't match
      set_fact:
        do_build: True

    - name: Write temp md5 file to disk
      copy: 
        content: "{{ data_file.stat.md5 }}"
        dest: "{{ inventory_dir }}/{{ file_name }}.md5.tmp"

    when: data_file.stat.md5 != old_md5_string.stdout

  when: md5_file.matched > 0
