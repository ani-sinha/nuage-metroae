- name: Clean known_hosts of VSD's (ignoring errors)
  known_hosts:
    name: "{{ hostname }}"
    state: absent
  delegate_to: localhost
  no_log: True
  ignore_errors: True

- name: Wait for Webfilter ssh to be ready
  include_role:
    name: common
    tasks_from: wait-for-ssh
  vars:
    ssh_host: "{{ hostname }}"
    host_username: "{{ vsd_default_username }}"

- block:

  - name: Create Webfilter SSL certs
    include_role:
      name: common
      tasks_from: vsd-generate-transfer-certificates
    vars:
      certificate_password: "{{ webfilter_default_password }}"
      certificate_username: "webfilter"
      commonName: "webfilter"
      certificate_type: server
      file_type: jks
      additional_parameters: "-p {{ webfilter_default_password }} -d {{ inventory_hostname }}"

- block:

  - name: Get the webfilter jks
    fetch:
      src: "/opt/vsd/ejbca/p12/webfilter.jks"
      dest: "/tmp/webfilter/"
      flat: yes

  - name: Get the truststore jks
    fetch:
      src: "/opt/vsd/ejbca/p12/truststore.jks"
      dest: "/tmp/webfilter/"
      flat: yes

    delegate_to: "{{ vsd_hostname_list[0] }}"

  - name: Copy to webfilter manager
    copy:
      dest: "/opt/vsd/webfilter/conf/"
      src: "/tmp/webfilter/"

  - name: Delete the temporary directory
    file:
      path: /tmp/webfilter
      state: absent

  - name: Verify that the /opt/vsd/webfilter/conf/application.properties file has the
          server.ssl.key-store=/opt/vsd/webfilter/conf/webfilter.jks
          server.ssl.key-store-password=<your-ks-password>
          server.ssl.key-alias=webfilter
          server.ssl.trust-store=/opt/vsd/webfilter/conf/truststore.jks
          server.ssl.trust-store-password=<your-ts-password>
    command: ls

  - name: Execute the following commands to stop and restart the web filtering process
          monit stop webfilter
          monit summary
          Process 'webfilter' Not monitored
          Program 'webfilter-status' Not monitored
          Process 'incompass-34-seed' Running
          Program 'incompass-34-seed-status' Status ok
          Process 'incompass' Running
          Program 'incompass-status' Status ok
          System 'localhost.localdomain' Running
    command: monit stop webfilter

  - name: monit start webfilter-status
          monit summary
          Process 'webfilter' Running
          Program 'webfilter-status' Status ok
          Process 'incompass-34-seed' Running
          Program 'incompass-34-seed-status' Status ok
          Process 'incompass' Running
          Program 'incompass-status' Status ok
          System 'localhost.localdomain' Running
    command: ls
  - name: Execute the monit summary command to ensure the services are operational
    command: ls

  - name: /opt/vsd/webfilter/scripts/incompassOperations.sh -a all -p /opt/vsd/webfilter/seed_34
          /opt/vsd/webfilter/scripts/incompassOperations.sh -a all
    command: ls

  - name: Execute the monit summary command again to ensure the services are still operational after
          the database download and update.
    command: ls

  - name: Connect with the NSG
    command: ls

  remote_user: "{{ webfilter_default_username }}"
