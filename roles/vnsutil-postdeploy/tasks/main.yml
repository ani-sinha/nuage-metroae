---
##TODO: Rewrite the vnsutil role to remove configuration from post deploy
- block:
  - name: Create dir to hold the keys
    file:
      path: "/opt/proxy/config/keys"
      state: directory

  - name: Get vsd node(s) information
    import_role:
      name: common
      tasks_from: vsd-node-info.yml
    vars:
      vsd_hostname: "{{ vsd_fqdn }}"
    run_once: true

  - name: Get VSD version
    shell: echo $VSD_VERSION
    register: vsd_version
    delegate_to: "{{ vsd_hostname_list[0] }}"

  - name: Create and transfer certs for VSD 4.0.4
    command: "{{ create_certs_404 }}"
    delegate_to: "{{ vsd_hostname_list[0] }}"
    when: "'4.0.4' in vsd_version.stdout"

  - name: Create and transfer certs
    command: "{{ create_certs }}"
    delegate_to: "{{ vsd_hostname_list[0] }}"
    when: "'4.0.4' not in vsd_version.stdout"

  - name: Install supervisord and haproxy
    command: "{{ install_cmd }}"

  - name: Start supervisord
    service:
      name: supervisord
      state: restarted
      enabled: true

  - name: Trigger generation of CRL file
    command: /opt/proxy/bin/crlreloader.sh

  - name: Wait for CRL file to be created, before starting HAProxy
    wait_for:
      path: /etc/haproxy/crl.pem
      state: present
      timeout: 60
      msg: Timeout waiting for CRL file to be created

  - name: Start haproxy
    service:
      name: haproxy
      state: started
      enabled: true

  - name: Add firewall rules to accept dhcp and dns requests
    lineinfile:
      insertafter: '<service name="ssh"/>'
      dest: /etc/firewalld/zones/public.xml
      line: "{{ item }}"
    with_items: "{{ firewall_rules }}"

  - name: Restart firewalld
    service:
      name: firewalld
      state: restarted

  - name: Get vsd node(s) information
    import_role:
      name: common
      tasks_from: vsd-node-info.yml
    vars:
      vsd_hostname: "{{ vsd_fqdn }}"
    run_once: true

  - name: Verify if proxy user is connected to the VSD
    command: /opt/ejabberd/bin/ejabberdctl connected_users
    register: proxy_user
    delegate_to: "{{ vsd_hostname_list[0] }}"
    until: proxy_user.stdout.find('proxy') != -1
    retries: 5
    delay: 30

# block properties
  remote_user: {{ vsd_username }}
