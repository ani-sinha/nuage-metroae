- name: Clean known_hosts of VSCs (ignoring errors)
  known_hosts:
    name: "{{ mgmt_ip }}"
    state: absent
  delegate_to: localhost
  no_log: True
  ignore_errors: True

- import_tasks: openstack.yml
  when: target_server_type is match("openstack")
  tags:
    - vsc
    - openstack
    - vsc-deploy

- import_tasks: kvm.yml
  when: target_server_type is match("kvm")
  tags:
    - vsc
    - vsc-deploy

- import_tasks: vcenter.yml
  when: target_server_type is match("vcenter")
  tags:
    - vsc
    - vsc-deploy

- name: Wait for VSC ssh to be ready
  include_role:
    name: common
    tasks_from: wait-for-ssh-port
  vars:
    ssh_host: "{{ hostname }}"
    ssh_timeout_seconds: 600
    ssh_password: "{{ vsc_creds.password }}"
    ssh_user: "{{ vsc_creds.username }}"
    check_login: True

- block:
  - name: Get vsd node(s) information
    import_role:
      name: common
      tasks_from: vsd-node-info.yml
    vars:
      vsd_hostname: "{{ vsd_fqdn }}"
    run_once: true

  - name: Change XMPP connection to TLS on VSD
    command: /opt/vsd/bin/ejmode allow -y
    delegate_to: "{{ item }}"
    with_items: "{{ vsd_hostname_list }}"
    when: xmpp_tls

  - name: wait for ejabberd-status to become running
    monit_waitfor_service:
      name: "ejabberd-status"
      timeout_seconds: 600
      test_interval_seconds: 30
    delegate_to: "{{ item }}"
    with_items: "{{ vsd_hostname_list }}"

  - name: wait for ejbca-status to become running
    monit_waitfor_service:
      name: "ejbca-status"
      timeout_seconds: 600
      test_interval_seconds: 30
    delegate_to: "{{ item }}"
    with_items: "{{ vsd_hostname_list }}"

  remote_user: "{{ vsd_custom_username | default(vsd_default_username) }}"
  become: "{{ 'no' if vsd_custom_username | default(vsd_default_username) == 'root' else 'yes' }}"
  vars:
    ansible_become_pass: "{{ vsd_custom_password | default(vsd_default_password) }}"

- name: Optionally setup XMPP TLS
  include_role:
    name: common
    tasks_from: vsc-tls-setup
