---
- name: Create dir to hold the keys 
  file: 
    path: "/opt/proxy/config/keys"
    state: directory

- name: Create and transfer certs to {{ inventory_hostname }}
  expect:
    command: "{{ create_certs }}"
    responses:
      (?i)password: "Alcateldc"
  delegate_to: "{{ vsd_fqdn }}"
  remote_user: root

- name: Install suervisord and haproxy
  command: "{{ install_cmd }}"

- name: Start supervisord
  service: 
    name: supervisord
    state: restarted

- name: Chkconfig supervisord
  command: chkconfig supervisord on

- name: Start haproxy
  service:
    name: haproxy
    state: started

- name: Chkconfig haproxy
  command: chkconfig haproxy on

- name: Add firewall rules to accept dhcp and dns requests
  lineinfile: 
    insertafter: '<service name="ssh"/>'
    dest: /etc/firewalld/zones/public.xml
    line: "{{ item }}"
  with_items: "{{ firewall_rules }}"

- name: Restart firewalld on {{ inventory_hostname }}
  service:
    name: firewalld
    state: restarted
