---
- name: Check for Ansible version >= 2.4
  assert:
    that: "ansible_version.major == 2 and ansible_version.minor >= 4"
    msg:  "Only Ansible version >= 2.4 is supported for VMware deployment, you are using {{ansible_version.full}}"

- name: Finding VM folder
  connection: local
  vmware_guest_find:
    hostname: "{{ target_server }}"
    username: "{{ vcenter.username }}"
    password: "{{ vcenter.password }}"
    datacenter: "{{ vcenter.datacenter }}"
    name: "{{ vm_name }}"
    validate_certs: no
  register: vm_folder
  ignore_errors: on

- name: Gathering info on VM
  connection: local
  vmware_guest_facts:
    hostname: "{{ target_server }}"
    username: "{{ vcenter.username }}"
    password: "{{ vcenter.password }}"
    datacenter: "{{ vcenter.datacenter }}"
    folder: "/{{ vcenter.datacenter }}{{ vm_folder['folders'][0] }}"
    name: "{{ vm_name }}"
    validate_certs: no
  register: vm_facts
  ignore_errors: yes
  when: vm_folder|succeeded

- name: Verify that the VM is not running if not reachable
  assert:
    that: "not (vm_folder|succeeded and vm_facts|succeeded and not node_reachable)"
    msg: "{{ vm_name }} is running on {{ target_server }} but is not reachable. Quitting."

- name: Verify that the VM is running if reachable
  assert:
    that: "not (vm_folder|failed and node_reachable)"
    msg: "{{ vm_name }} is not running on {{ target_server }} but the address is reachable. Quitting."

- name: Set fact for node running
  set_fact:
    node_running: "{{ vm_facts|succeeded }}"
