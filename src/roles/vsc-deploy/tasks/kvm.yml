---

- name: Set local variable with vmname
  set_fact:
    vm_name: "{{ vmname }}"

- block:

  - name: Setup VSC temporary configuration files
    template: src=config.cfg.j2 backup=no dest={{ images_path }}/{{ vm_name }}/config.cfg

  - name: Copy temporary configuration files to the VSC image
    command: guestfish --rw -a {{ images_path }}/{{ vm_name }}/{{ inventory_hostname }}.qcow2 -m {{ vsc_partition }} copy-in {{ images_path }}/{{ vm_name }}/config.cfg /

  - name: Remove temporary configuration files
    file: path={{ images_path }}/{{ vm_name }}/config.cfg state=absent

  delegate_to: "{{ target_server }}"
  remote_user: "{{ target_server_username }}"
  become: "{{ 'no' if target_server_username == 'root' else 'yes' }}"