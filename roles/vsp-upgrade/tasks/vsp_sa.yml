---
- name: Query facts on ansible_deployment_host
  action: setup
  run_once: true
  delegate_to: "{{ ansible_deployment_host }}"
  remote_user: "{{ ansible_sudo_username }}"

- name: Get VSD nodes network and monit information prior to upgrade
  any_errors_fatal: true
  vars:
    report_filename: vsd_pre_upgrade_report.txt
  include_role:
    name: vsd-health
  when: inventory_hostname in groups['vsds']

- name: Get VSC nodes information prior to upgrade
  any_errors_fatal: true
  vars:
    report_filename: vsc_pre_upgrade_report.txt
  include_role:
    name: vsc-health
  when: inventory_hostname in groups['vscs']
  
- name: Perform vsd database backup
  include_role:
    name: vsd-dbbackup
  when: inventory_hostname in groups['vsds']

- name: Stop vsd services gracefully
  include_role:
    name: stop-vsd-services

- name: Upgrade VSD node1
  include_role:
    name: vsd-upgrade
  when: inventory_hostname == groups['vsds'][0]


- name: Get VSD nodes network and monit informtion after  enabling VSD API
  any_errors_fatal: true
  vars:
    report_filename: vsd_post_vsd1_upgrade_report.txt
  include_role:
    name: vsd-health

- name: Get VSC nodes information prior to upgrade VSC1
  any_errors_fatal: true
  vars:
    report_filename: vsc_pre_vsc1_upgrade_report.txt
  include_role:
    name: vsc-health
  when: inventory_hostname in groups['vscs']

- name: Backup VSC node1
  any_errors_fatal: true
  include_role:
    name: vsc-backup
  when: inventory_hostname == vsc_ha_node1


- name: Upgrade VSC node1
  gather_facts: no
  any_errors_fatal: true
  include_role:
    name: vsc-upgrade
  when: inventory_hostname == vsc_ha_node1

- name: Get VSC nodes information post VSC1 upgrade
  any_errors_fatal: true
  vars:
    report_filename: vsc_post_vsc1_upgrade_report.txt
  include_role:
    name: vsc-health
  when: inventory_hostname in groups['vscs']

- name: Upgrade VSC node2
  gather_facts: no
  any_errors_fatal: true
  include_role:
    name: vsc-upgrade
  when: inventory_hostname == vsc_ha_node2 

- name: Get VSC nodes information post VSC2 upgrade
  any_errors_fatal: true
  vars:
    report_filename: vsc_post_vsc2_upgrade_report.txt
  include_role:
    name: vsc-health
  when: inventory_hostname in groups['vscs']

- name: Get VSC nodes information post upgrade
  any_errors_fatal: true
  vars:
    report_filename: vsc_post_upgrade_report.txt
  include_role:
    name: vsc-health
  when: inventory_hostname in groups['vscs']
