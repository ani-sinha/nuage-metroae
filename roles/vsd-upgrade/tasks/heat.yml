---
- block:
  - name: Shutdown VSD Node1 and Node3
    os_server_actions:
      action: stop
      auth:
        "{{ os_auth }}"
      server: "{{ inventory_hostname }}"
    delegate_to: "{{ ansible_deployment_host }}"

  - name: Deploy VSD Node1 and Node3 with new version
    include_role:
      name: vsd-predeploy
    vars:
      stack_name: "{{ inventory_hostname }}-new"

  - name: Wait for VSD ssh to be ready
    local_action:
      module: wait_for
      port: "22"
      host: "{{ interfaces.mgmt.ip }}"
      search_regex: OpenSSH
      delay: 1
 
  - include: upgrade_vsd.yml
  when: inventory_hostname == groups['vsds'][0] or inventory_hostname == groups['vsds'][2]
