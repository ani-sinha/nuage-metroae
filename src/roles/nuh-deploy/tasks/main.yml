---
- name: Clean known_hosts of NUH's (ignoring errors)
  known_hosts:
    name: "{{ hostname }}"
    state: absent
  delegate_to: localhost
  no_log: True
  ignore_errors: True

- name: Wait for NUH ssh to be ready
  include_role:
    name: common
    tasks_from: wait-for-ssh
  vars:
    ssh_host: "{{ hostname }}"
    host_username: "root"

- block:

  - name: Run the setup script
    shell: ./setup.sh
    environment:
      HNAME: "{{ hostname }}"
      HA: "n"
    args:
      chdir: /opt/proxy/bin
    when: nuh_sa_or_ha is match('sa')

  - name: Set the timezone
    command: timedatectl set-timezone {{ nuh_timezone }}

  - name: Copy license file
    copy:
      src: "{{ nuh_license_file }}"
      dest: "/opt/proxy/nuh.license"
    when: nuh_license_file is defined

    - name: Create and transfer certs
      include_role:
        name: common
        tasks_from: vsd-generate-transfer-certificates
      vars:
        certificate_password: "{{ nuh_default_password }}"
        certificate_username: "{{ inventory_hostname }}"
        commonName: "{{ inventory_hostname }}"
        certificate_type: server
        scp_user: "root"
        scp_location: /opt/proxy/data/certs
        additional_parameters:  -d {{ inventory_hostname }}

  remote_user: "{{ nuh_default_username }}"
