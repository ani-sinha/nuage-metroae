# Install Pre-Requisites
- name: Pull facts of localhost
  setup:
  delegate_to: localhost

- name: Set name for backup folder
  set_fact:
    backup_folder: "backup-{{ inventory_hostname }}-{{ ansible_date_time.iso8601_basic_short }}"

- block:

  - name: Create backup dir to hold backup files
    file:
      path: "{{ metro_backup_root }}/{{ backup_folder }}"
      state: directory

  - name: Create temporary dir to hold backup files
    file:
      path: "/tmp/{{ backup_folder }}"
      state: directory

  - name: Transfer bof.cfg from VSC to backup_machine
    command: "{{ vsc_scp_backup_bof }}"
    no_log: "{{ lookup('env', 'METROAE_NO_LOG') or 'true' }}"

  - name: Transfer config.cfg from VSC to backup_machine
    command: "{{ vsc_scp_backup_config }}"
    no_log: "{{ lookup('env', 'METROAE_NO_LOG') or 'true' }}"

  - name: Transfer primary image from VSC to backup_machine
    command: "{{ vsc_scp_backup_primary_image }}"
    no_log: "{{ lookup('env', 'METROAE_NO_LOG') or 'true' }}"
    when: not skip_backup_vsc_image | default(False)

  - name: Create symbolic link to backup location
    file:
      dest: "{{ metro_backup_root }}/backup-{{ groups['vscs'][0] }}-latest"
      src: "/tmp/{{ backup_folder }}"
      state: link
      follow: false

  delegate_to: localhost
