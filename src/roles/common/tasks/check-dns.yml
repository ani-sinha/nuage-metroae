---
- name: Retrieve Host IP
  shell: "getent hosts {{ item.hostname }} | awk '{print $1}'"
  register: hostip

- name: Ensure that the hostname maps to the proper mgmt IP
  assert:
    that: "'{{ hostip.stdout }}' ==  '{{ item.mgmt_ip }}'"
    msg: "IPv4 address for {{item.hostname}} != {{item.mgmt_ip}}"

- name: Set hostname for dns lookup
  set_fact:
    hostname: "{{item.hostname}}"

- name: Set hostname for dns lookup
  set_fact:
    management_ip: "{{item.mgmt_ip}}"

- name: Ensure FQDNs are correct in the DNS server list
  command: "dig +short {{hostname}} @{{dns_server}}"
  with_items: "{{dns_server_list}}"
  register: dns_resolved_addresses
  loop_control:
    loop_var: dns_server

- name: Assert ip address found by DNS is correct
  assert:
    that: "'{{ dns_addr.stdout }}' ==  '{{ management_ip }}'"
    msg: "IPv4 address found by DNS {{dns_addr.stdout}} != {{management_ip}}"
  with_items: "{{dns_resolved_addresses.results}}"
  loop_control:
    loop_var: dns_addr

- block:

    - shell: "getent hosts {{ item.data_fqdn }} | awk '{print $1}'"
      register: data_fqdn_ip

    - name: Ensure that the data FQDN maps to the proper data IP
      assert:
        that: "'{{ data_fqdn_ip.stdout }}' ==  '{{ item.data_ip }}'"
        msg: "IPv4 address for {{item.data_fqdn}} != {{item.data_ip}}"

  when: vnsutils is defined and vnsutils
