AWSTemplateFormatVersion: 2010-09-09
Description: >-
  AWS CloudFormation Template to deploy a proxy for access to VPC. **WARNING**
  This template creates an Amazon EC2 instance and ElasticIP. You will be billed
  for these AWS resources used if you create a stack from this template.
Parameters:
  KeyName:
    Description: Name of an existing EC2 KeyPair to enable SSH access to the instance
    Type: 'AWS::EC2::KeyPair::KeyName'
    ConstraintDescription: must be the name of an existing EC2 KeyPair.
  ProxyAccessEniId:
    Description: NetworkInterface ID for Proxy Access interface
    Type: String
  ProxyMgmtEniId:
    Description: NetworkInterface ID for Proxy Management interface
    Type: String
  ProxyAccessEipId:
    Description: ID for Access network Elastic IP
    Type: String
    Default: ''
  AmiId:
    Description: AMI-ID for Instance
    Type: 'AWS::EC2::Image::Id'
    ConstraintDescription: AMI must already be availabe in this Region
  InstanceType:
    Description: EC2 instance type
    Type: String
    Default: t2.medium
    AllowedValues:
      - t2.small
      - t2.medium
      - m4.large
      - c3.8xlarge
      - c4.8xlarge
      - g2.8xlarge
      - r3.8xlarge
      - i2.8xlarge
      - d2.8xlarge
      - hi1.4xlarge
      - hs1.8xlarge
      - cr1.8xlarge
      - cc2.8xlarge
      - m2.4xlarge
      - m4.4xlarge
      - cg1.4xlarge
    ConstraintDescription: must be a valid EC2 instance type.
  InstanceName:
    Description: Enter Name for Instance
    ConstraintDescription: Instance Name
    Type: String
Conditions:
  CreateEIP: !Equals
    - !Ref ProxyAccessEipId
    - ''
Resources:
  ProxyInstance:
    Type: 'AWS::EC2::Instance'
    DependsOn: EIPAssociation
    Properties:
      InstanceType: !Ref InstanceType
      KeyName: !Ref KeyName
      ImageId: !Ref AmiId
      NetworkInterfaces:
        - DeviceIndex: '0'
          NetworkInterfaceId: !Ref ProxyMgmtEniId
        - DeviceIndex: '1'
          NetworkInterfaceId: !Ref ProxyAccessEniId
      UserData: ''
      Tags:
        - Key: Name
          Value: !Ref InstanceName
      BlockDeviceMappings:
        - DeviceName: /dev/sda1
          Ebs:
            DeleteOnTermination: true
  EIP:
    Type: 'AWS::EC2::EIP'
    Condition: CreateEIP
    Properties:
      Domain: vpc
  EIPAssociation:
    Type: 'AWS::EC2::EIPAssociation'
    Properties:
      AllocationId: !If
        - CreateEIP
        - !GetAtt
          - EIP
          - AllocationId
        - !Ref ProxyAccessEipId
      NetworkInterfaceId: !Ref ProxyAccessEniId
Outputs:
  InstanceId:
    Description: InstanceId of the newly created EC2 instance
    Value: !Ref ProxyInstance
  AZ:
    Description: Availability Zone of the newly created EC2 instance
    Value: !GetAtt
      - ProxyInstance
      - AvailabilityZone
  PublicDNS:
    Description: Public DNSName of the newly created EC2 instance
    Value: !GetAtt
      - ProxyInstance
      - PublicDnsName
