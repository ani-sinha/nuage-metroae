---
- block:

  - block:

    - name: Renew standalone VSD certificate
      command: /opt/vsd/bin/vsd-renew-certs.sh

    - name: Verify if VSD TLS mode is set to allow
      command: /opt/vsd/bin/ejmode status
      register: ejmode

    - name: Restart ejabberd
      command: monit restart ejabberd
      when: ejmode.stdout is search('allow')

    - name: wait for ejabberd to come up
      monit_waitfor_service:
        name: ejabberd
        timeout_seconds: 600
        test_interval_seconds: 30

    - name: Stop VSD core service
      shell: monit stop -g vsd-core

    - name: Pause for processes to exit
      pause:
        seconds: 20

    - name: Restart the VSD core service
      shell: monit start -g vsd-core

    - name: Wait VSD core to start
      monit_waitfor_service:
        name: vsd-core-status
        timeout_seconds: 600
        test_interval_seconds: 30

    - name: Get monit summary for all process on VSD
      vsd_monit:
        group: all
      register: vsd_process_list

    - name: Restart stats if enabled
      shell: monit restart -g vsd-stats
      when: "'stats-collector' in vsd_process_list['state'].keys()"

    when:
      - vsd_sa_or_ha is match ('sa')
      - not vsd_standby_cluster | default(False)

    remote_user: "{{ vsd_custom_username | default(vsd_default_username) }}"
    become: "{{ 'no' if vsd_custom_username | default(vsd_default_username) == 'root' else 'yes' }}"
    vars:
      ansible_become_pass: "{{ vsd_custom_password | default(vsd_default_password) }}"

  - block:

    - name: Renew primary VSD cert
      command: /opt/vsd/bin/vsd-renew-certs.sh
      delegate_to: "{{ item }}"
      with_items: "{{ groups['vsd_ha_node1'][0] }}"
      remote_user: "{{ hostvars[item].vsd_custom_username | default( vsd_custom_username | default(vsd_default_username)) }}"
      become: "{{ 'no' if hostvars[item].vsd_custom_username | default( vsd_custom_username | default(vsd_default_username)) == 'root' else 'yes' }}"
      vars:
        ansible_become_pass: "{{ hostvars[item].vsd_custom_password | default( vsd_custom_password | default(vsd_default_password)) }}"

    - name: Renew other 2 VSD certs
      command: /opt/vsd/bin/vsd-renew-certs.sh -1 {{ hostvars[groups['primary_vsds'][0]]['hostname'] }}
      delegate_to: "{{ item }}"
      with_items:
        - "{{ groups['vsd_ha_node2'][0] }}"
        - "{{ groups['vsd_ha_node3'][0] }}"
      remote_user: "{{ hostvars[item].vsd_custom_username | default( vsd_custom_username | default(vsd_default_username)) }}"
      become: "{{ 'no' if hostvars[item].vsd_custom_username | default( vsd_custom_username | default(vsd_default_username)) == 'root' else 'yes' }}"
      vars:
        ansible_become_pass: "{{ hostvars[item].vsd_custom_password | default( vsd_custom_password | default(vsd_default_password)) }}"

    - name: Restart Ejabberd on cert renewal
      include_role:
        name: common
        tasks_from: restart-ejabberd-on-cert-renew.yml
      with_items:
        "{{ groups['primary_vsds'] }}"
      loop_control:
        loop_var: vsd

    - block:
      - name: Get monit summary for all process on VSD
        vsd_monit:
          group: all
        register: vsd_process_list

      - name: Restart stats if enabled
        shell: monit restart -g vsd-stats
        when: "'stats-collector' in vsd_process_list['state'].keys()"

      delegate_to: "{{ groups['vsd_ha_node1'][0] }}"
      remote_user: "{{ hostvars[groups['vsd_ha_node1'][0]].vsd_custom_username | default( vsd_custom_username | default(vsd_default_username)) }}"
      become: "{{ 'no' if hostvars[groups['vsd_ha_node1'][0]].vsd_custom_username | default( vsd_custom_username | default(vsd_default_username)) == 'root' else 'yes' }}"
      vars:
        ansible_become_pass: "{{ hostvars[groups['vsd_ha_node1'][0]].vsd_custom_password | default( vsd_custom_password | default(vsd_default_password)) }}"

    when: vsd_sa_or_ha is match ('ha')

  - block:

    - name: Renew standby VSD certs
      command: /opt/vsd/bin/vsd-renew-certs.sh -1 {{ hostvars[groups['primary_vsds'][0]]['hostname'] }}
      delegate_to: "{{ item }}"
      with_items:
        "{{ groups['standby_vsds'] }}"
      remote_user: "{{ hostvars[item].vsd_custom_username | default( vsd_custom_username | default(vsd_default_username)) }}"
      become: "{{ 'no' if hostvars[item].vsd_custom_username | default( vsd_custom_username | default(vsd_default_username)) == 'root' else 'yes' }}"
      vars:
        ansible_become_pass: "{{ hostvars[item].vsd_custom_password | default( vsd_custom_password | default(vsd_default_password)) }}"

    - name: Restart Ejabberd on cert renewal
      include_role:
        name: common
        tasks_from: restart-ejabberd-on-cert-renew.yml
      with_items:
        "{{ groups['standby_vsds'] }}"
      loop_control:
        loop_var: vsd

    when: vsd_standby_cluster | default(False)
